<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discord Bot Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }

    :root {
      --bg0: #06070a;
      --bg1: #0b0d12;
      --panel: rgba(20, 22, 31, 0.72);
      --panel2: rgba(12, 13, 18, 0.62);
      --border: rgba(255, 255, 255, 0.06);
      --text: #e8e8ea;
      --muted: rgba(232, 232, 234, 0.7);
      --red: #ff2d2d;
      --red2: #ff4d6d;
      --green: #21c55d;
      --shadow: 0 20px 80px rgba(0,0,0,0.55);
    }

    .discord-darkest { background: radial-gradient(1200px 600px at 50% 0%, rgba(255,45,45,0.10), transparent 60%), linear-gradient(180deg, var(--bg0), var(--bg1)); }
    .discord-darker { background: var(--panel); border: 1px solid var(--border); backdrop-filter: blur(14px); box-shadow: var(--shadow); }
    .discord-dark { background: var(--panel2); border: 1px solid var(--border); backdrop-filter: blur(12px); }
    .discord-input { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); }
    .discord-input:focus { border-color: rgba(255,45,45,0.55); box-shadow: 0 0 0 3px rgba(255,45,45,0.18); }
    .discord-green { background: linear-gradient(135deg, #16a34a, var(--green)); box-shadow: 0 10px 30px rgba(34,197,94,0.18); }
    .discord-blurple { background: linear-gradient(135deg, var(--red), var(--red2)); box-shadow: 0 12px 34px rgba(255,45,45,0.22); }

    .neon-title { text-shadow: 0 0 18px rgba(255,45,45,0.35), 0 0 42px rgba(255,45,45,0.18); }
    .glow-ring { box-shadow: 0 0 0 1px rgba(255,45,45,0.14), 0 18px 60px rgba(255,45,45,0.10); }
    .hover-lift { transition: transform 220ms ease, box-shadow 220ms ease, opacity 220ms ease; }
    .hover-lift:hover { transform: translateY(-2px); opacity: 0.98; }
    .tab-btn { transition: transform 180ms ease, background-color 180ms ease, opacity 180ms ease; }
    .tab-btn:hover { transform: translateY(-1px); }
    .tab-content { animation: fadeUp 220ms ease; }

    @keyframes floaty {
      0% { transform: translate3d(0,0,0) scale(1); opacity: 0.2; }
      50% { transform: translate3d(0,-14px,0) scale(1.04); opacity: 0.35; }
      100% { transform: translate3d(0,0,0) scale(1); opacity: 0.22; }
    }

    @keyframes fadeUp {
      from { transform: translateY(6px); opacity: 0.0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .bg-grid {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(255,45,45,0.22), transparent 40%),
        radial-gradient(circle at 90% 30%, rgba(255,77,109,0.16), transparent 45%),
        radial-gradient(circle at 50% 90%, rgba(255,45,45,0.10), transparent 45%),
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: auto, auto, auto, 48px 48px, 48px 48px;
      background-position: center;
      opacity: 0.9;
      filter: saturate(1.1);
    }

    .bg-particles { position: fixed; inset: 0; pointer-events: none; overflow: hidden; }
    .bg-particles span {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      background: radial-gradient(circle, rgba(255,45,45,0.9), rgba(255,45,45,0.0) 70%);
      filter: blur(0.2px);
      animation: floaty var(--dur) ease-in-out infinite;
      opacity: 0.22;
    }

    select.discord-input { color: var(--text); background: rgba(255,255,255,0.06); }
    select.discord-input option { color: #e8e8ea; background: #0b0d12; }
    select.discord-input optgroup { color: #e8e8ea; background: #0b0d12; }
  </style>
</head>
<body class="discord-darkest min-h-screen text-gray-100">

  <div class="bg-grid"></div>
  <div class="bg-particles" aria-hidden="true">
    <span style="left: 8%; top: 18%; --dur: 4.2s;"></span>
    <span style="left: 18%; top: 72%; --dur: 5.4s;"></span>
    <span style="left: 34%; top: 28%; --dur: 3.8s;"></span>
    <span style="left: 52%; top: 14%; --dur: 4.9s;"></span>
    <span style="left: 66%; top: 64%; --dur: 5.8s;"></span>
    <span style="left: 78%; top: 22%; --dur: 4.6s;"></span>
    <span style="left: 90%; top: 78%; --dur: 6.2s;"></span>
  </div>
  
  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center">
    <div class="discord-darker p-8 rounded-2xl w-96 glow-ring hover-lift">
      <h1 class="text-2xl font-bold text-center mb-6 neon-title">ü§ñ Bot Dashboard</h1>
      <input type="password" id="passwordInput" placeholder="Contrase√±a" 
        class="w-full p-3 rounded discord-input text-white mb-4 outline-none focus:ring-2 focus:ring-indigo-500">
      <button onclick="login()" class="w-full discord-blurple p-3 rounded-xl font-semibold hover:opacity-90 transition hover-lift">
        Iniciar Sesi√≥n
      </button>
      <p id="loginError" class="text-red-400 text-center mt-3 hidden">Contrase√±a incorrecta</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <!-- Sidebar -->
    <div class="flex">
      <aside class="w-64 discord-darker min-h-screen p-4 fixed">
        <div id="botInfo" class="flex items-center gap-3 mb-6 p-3 discord-dark rounded-xl hover-lift">
          <img id="botAvatar" src="" class="w-10 h-10 rounded-full">
          <div>
            <p id="botName" class="font-semibold"></p>
            <p class="text-xs text-gray-400"><span id="guildCount">0</span> servidores</p>
          </div>
        </div>

        <h3 class="text-xs font-semibold text-gray-400 uppercase mb-2">Servidores</h3>
        <div id="guildList" class="space-y-1 max-h-96 overflow-y-auto"></div>
      </aside>

      <!-- Main Content -->
      <main class="ml-64 flex-1 p-6">
        <div class="max-w-4xl mx-auto">
          
          <!-- Channel Selector -->
          <div class="discord-darker p-4 rounded-2xl mb-6 hover-lift">
            <label class="text-sm text-gray-400 mb-2 block">Canal seleccionado</label>
            <select id="channelSelect" class="w-full p-3 rounded discord-input text-white outline-none">
              <option value="">Selecciona un servidor primero</option>
            </select>
          </div>

          <!-- Tabs -->
          <div class="flex gap-2 mb-4">
            <button onclick="showTab('simple')" class="tab-btn active px-4 py-2 rounded discord-blurple" data-tab="simple">
              üí¨ Mensaje Simple
            </button>
            <button onclick="showTab('setup')" class="tab-btn px-4 py-2 rounded discord-dark" data-tab="setup">
              ‚ö° Setup
            </button>
            <button onclick="showTab('raid')" class="tab-btn px-4 py-2 rounded discord-dark" data-tab="raid">
              üö® Anti-Raid
            </button>
            <button onclick="showTab('moderation')" class="tab-btn px-4 py-2 rounded discord-dark" data-tab="moderation">
              üõ°Ô∏è Moderaci√≥n
            </button>
            <button onclick="showTab('logs')" class="tab-btn px-4 py-2 rounded discord-dark" data-tab="logs">
              üìú Logs
            </button>
            <button onclick="showTab('verify')" class="tab-btn px-4 py-2 rounded discord-dark" data-tab="verify">
              ‚úÖ Verificaci√≥n
            </button>
            <button onclick="showTab('backup')" class="tab-btn px-4 py-2 rounded discord-dark" data-tab="backup">
              üíæ Backup
            </button>
            <button onclick="showTab('health')" class="tab-btn px-4 py-2 rounded discord-dark" data-tab="health">
              ‚ù§Ô∏è Salud
            </button>
            <button onclick="showTab('embed')" class="tab-btn px-4 py-2 rounded discord-dark" data-tab="embed">
              üìã Embed
            </button>
            <button onclick="showTab('image')" class="tab-btn px-4 py-2 rounded discord-dark" data-tab="image">
              üñºÔ∏è Imagen
            </button>
            <button onclick="showTab('product')" class="tab-btn px-4 py-2 rounded discord-dark" data-tab="product">
              üõí Producto
            </button>
            <button onclick="showTab('tickets')" class="tab-btn px-4 py-2 rounded discord-dark" data-tab="tickets">
              üé´ Tickets
            </button>
            <button onclick="showTab('welcome')" class="tab-btn px-4 py-2 rounded discord-dark" data-tab="welcome">
              üëã Bienvenida
            </button>
          </div>

          <div class="discord-darker p-4 rounded-2xl mb-6 hover-lift">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h3 class="text-sm font-semibold">Ayudas (variables y plantillas)</h3>
                <p class="text-xs text-gray-400">Haz click en un campo y usa estos botones para insertar variables autom√°ticamente.</p>
              </div>
              <button onclick="toggleHelpers()" class="discord-dark px-4 py-2 rounded font-semibold hover:opacity-90">Mostrar/Ocultar</button>
            </div>

            <div id="helpersPanel" class="mt-4">
              <div class="flex flex-wrap gap-2">
                <button onclick="insertPlaceholder('{user}')" class="discord-dark px-3 py-2 rounded text-sm hover:opacity-90">{user}</button>
                <button onclick="insertPlaceholder('{userId}')" class="discord-dark px-3 py-2 rounded text-sm hover:opacity-90">{userId}</button>
                <button onclick="insertPlaceholder('{mention}')" class="discord-dark px-3 py-2 rounded text-sm hover:opacity-90">{mention}</button>
                <button onclick="insertPlaceholder('{order}')" class="discord-dark px-3 py-2 rounded text-sm hover:opacity-90">{order}</button>
                <button onclick="insertPlaceholder('{plan}')" class="discord-dark px-3 py-2 rounded text-sm hover:opacity-90">{plan}</button>
                <button onclick="insertPlaceholder('{guildId}')" class="discord-dark px-3 py-2 rounded text-sm hover:opacity-90">{guildId}</button>
                <button onclick="insertPlaceholder('{guildName}')" class="discord-dark px-3 py-2 rounded text-sm hover:opacity-90">{guildName}</button>
                <button onclick="insertPlaceholder('{memberCount}')" class="discord-dark px-3 py-2 rounded text-sm hover:opacity-90">{memberCount}</button>
              </div>

              <div class="mt-3 flex flex-wrap gap-2">
                <button onclick="applyPreset('ticket-default')" class="discord-blurple px-3 py-2 rounded text-sm font-semibold hover:opacity-90">Plantilla: Tickets (default)</button>
                <button onclick="applyPreset('shop-default')" class="discord-blurple px-3 py-2 rounded text-sm font-semibold hover:opacity-90">Plantilla: Panel Tienda</button>
                <button onclick="applyPreset('embed-default')" class="discord-blurple px-3 py-2 rounded text-sm font-semibold hover:opacity-90">Plantilla: Embed b√°sico</button>
                <button onclick="applyPreset('welcome-default')" class="discord-blurple px-3 py-2 rounded text-sm font-semibold hover:opacity-90">Plantilla: Bienvenida</button>
                <button onclick="applyPreset('moderation-default')" class="discord-blurple px-3 py-2 rounded text-sm font-semibold hover:opacity-90">Plantilla: Moderaci√≥n</button>
                <button onclick="applyPreset('logs-default')" class="discord-blurple px-3 py-2 rounded text-sm font-semibold hover:opacity-90">Plantilla: Logs</button>
                <button onclick="applyPreset('verify-default')" class="discord-blurple px-3 py-2 rounded text-sm font-semibold hover:opacity-90">Plantilla: Verificaci√≥n</button>
                <button onclick="applyPreset('raid-default')" class="discord-blurple px-3 py-2 rounded text-sm font-semibold hover:opacity-90">Plantilla: Anti-Raid</button>
              </div>

              <p class="text-xs text-gray-400 mt-3">Tip: Puedes usar estas variables en tickets (nombre canal / intro / bienvenida). En mensajes simples tambi√©n funciona.</p>
            </div>
          </div>

          <!-- Simple Message Tab -->
          <div id="simpleTab" class="tab-content discord-darker p-6 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">Enviar Mensaje Simple</h2>
            <textarea id="simpleMessage" rows="4" placeholder="Escribe tu mensaje... Puedes usar emojis üéÆ y formato **negrita**"
              class="w-full p-3 rounded discord-input text-white outline-none resize-none mb-4"></textarea>
            <button onclick="sendSimpleMessage()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">
              Enviar Mensaje
            </button>
          </div>

          <!-- Setup Tab -->
          <div id="setupTab" class="tab-content discord-darker p-6 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-2">‚ö° Setup R√°pido (1 click)</h2>
            <p class="text-sm text-gray-400 mb-4">Crea categor√≠as, canales, roles y publica mensajes base. Primero usa Preview para ver qu√© va a crear.</p>

            <div class="flex flex-wrap gap-3 mb-4">
              <button onclick="setupPreview()" class="discord-dark px-6 py-2 rounded font-semibold hover:opacity-90">Preview</button>
              <button onclick="setupApply()" class="discord-blurple px-6 py-2 rounded font-semibold hover:opacity-90">Aplicar</button>
              <button onclick="configureAll()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">Configurar TODO</button>
            </div>

            <div class="discord-dark p-4 rounded-lg">
              <h3 class="text-sm font-semibold mb-2">Acciones</h3>
              <div id="setupActions" class="text-sm text-gray-300 space-y-1"></div>
            </div>
          </div>

          <!-- Raid Tab -->
          <div id="raidTab" class="tab-content discord-darker p-6 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-2">üö® Anti-Raid</h2>
            <p class="text-sm text-gray-400 mb-4">Detecta entradas masivas y activa modo defensa (slowmode temporal). Configurable por servidor (Firestore).</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="discord-dark p-4 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                  <label class="text-sm font-semibold">Activar Anti-Raid</label>
                  <input type="checkbox" id="raidEnabled" class="rounded">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">Ventana joins (ms)</label>
                    <input type="number" id="raidJoinWindowMs" value="15000" class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">Umbral joins</label>
                    <input type="number" id="raidJoinThreshold" value="8" class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">Duraci√≥n defensa (ms)</label>
                    <input type="number" id="raidDefenseDurationMs" value="300000" class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">Slowmode (seg)</label>
                    <input type="number" id="raidSlowmodeSeconds" value="10" class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                </div>

                <label class="text-sm text-gray-400 block mt-3 mb-1">Canal logs (opcional)</label>
                <select id="raidLogChannelSelect" class="w-full p-3 rounded discord-input text-white outline-none">
                  <option value="">(Sin logs)</option>
                </select>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                  <button onclick="loadRaidSettings()" class="discord-dark px-6 py-2 rounded font-semibold hover:opacity-90">Cargar</button>
                  <button onclick="saveRaidSettings()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">Guardar</button>
                </div>
              </div>

              <div class="discord-dark p-4 rounded-lg">
                <h3 class="text-sm font-semibold mb-3">Ayuda r√°pida</h3>
                <p class="text-sm text-gray-300">Recomendado: 8 joins en 15s, defensa 5min, slowmode 10s.</p>
                <p class="text-sm text-gray-300 mt-2">Tip: pon el canal logs privado solo para STAFF.</p>
              </div>
            </div>
          </div>

          <!-- Moderation Tab -->
          <div id="moderationTab" class="tab-content discord-darker p-6 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-2">üõ°Ô∏è Moderaci√≥n</h2>
            <p class="text-sm text-gray-400 mb-4">Anti-links, anti-invites y anti-spam configurables por servidor (Firestore).</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="discord-dark p-4 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                  <label class="text-sm font-semibold">Activar moderaci√≥n</label>
                  <input type="checkbox" id="modEnabled" class="rounded" checked>
                </div>

                <div class="flex items-center gap-2 mb-2">
                  <input type="checkbox" id="modBlockLinks" class="rounded" checked>
                  <label for="modBlockLinks" class="text-sm text-gray-300">Bloquear links</label>
                </div>

                <div class="flex items-center gap-2 mb-3">
                  <input type="checkbox" id="modBlockInvites" class="rounded" checked>
                  <label for="modBlockInvites" class="text-sm text-gray-300">Bloquear invites</label>
                </div>

                <label class="text-sm text-gray-400 block mb-1">Whitelist dominios (uno por l√≠nea)</label>
                <textarea id="modWhitelist" rows="5" placeholder="youtube.com\ndiscord.com" class="w-full p-2 rounded discord-input text-white outline-none resize-none"></textarea>

                <label class="text-sm text-gray-400 block mt-3 mb-1">Canal de logs (opcional)</label>
                <select id="modLogChannelSelect" class="w-full p-3 rounded discord-input text-white outline-none">
                  <option value="">(Sin logs)</option>
                </select>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                  <button onclick="loadModerationSettings()" class="discord-dark px-6 py-2 rounded font-semibold hover:opacity-90">Cargar</button>
                  <button onclick="saveModerationSettings()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">Guardar</button>
                </div>
              </div>

              <div class="discord-dark p-4 rounded-lg">
                <h3 class="text-sm font-semibold mb-3">Anti-spam</h3>
                <div class="flex items-center justify-between mb-3">
                  <label class="text-sm font-semibold">Activar anti-spam</label>
                  <input type="checkbox" id="spamEnabled" class="rounded" checked>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">Ventana (ms)</label>
                    <input type="number" id="spamWindowMs" value="7000" class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">M√°x msgs</label>
                    <input type="number" id="spamMaxMsgs" value="6" class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">Timeout (ms)</label>
                    <input type="number" id="spamTimeoutMs" value="60000" class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                </div>

                <label class="text-sm text-gray-400 block mt-3 mb-1">Exento por roles (IDs separados por coma)</label>
                <input type="text" id="modExemptRoleIds" placeholder="123,456" class="w-full p-2 rounded discord-input text-white outline-none">

                <label class="text-sm text-gray-400 block mt-3 mb-1">Exento por canales (IDs separados por coma)</label>
                <input type="text" id="modExemptChannelIds" placeholder="123,456" class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
            </div>
          </div>

          <!-- Backup Tab -->
          <div id="backupTab" class="tab-content discord-darker p-6 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-2">üíæ Backup / Export / Import</h2>
            <p class="text-sm text-gray-400 mb-4">Exporta toda tu configuraci√≥n (settings + templates). Tambi√©n puedes importar para clonar a otro servidor.</p>

            <div class="flex flex-wrap gap-3 mb-4">
              <button onclick="exportBackup()" class="discord-blurple px-6 py-2 rounded font-semibold hover:opacity-90">Exportar</button>
              <button onclick="importBackup()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">Importar</button>
            </div>

            <div class="discord-dark p-4 rounded-lg">
              <label class="text-sm text-gray-400 block mb-2">JSON de backup (pega aqu√≠ para importar)</label>
              <textarea id="backupJson" rows="10" class="w-full p-3 rounded discord-input text-white outline-none resize-none" placeholder="{ ... }"></textarea>
            </div>
          </div>

          <!-- Health Tab -->
          <div id="healthTab" class="tab-content discord-darker p-6 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-2">‚ù§Ô∏è Salud del Servidor</h2>
            <p class="text-sm text-gray-400 mb-4">Checklist autom√°tico para ver qu√© est√° configurado y qu√© falta.</p>

            <div class="flex flex-wrap gap-3 mb-4">
              <button onclick="healthCheck()" class="discord-blurple px-6 py-2 rounded font-semibold hover:opacity-90">Actualizar</button>
            </div>

            <div class="discord-dark p-4 rounded-lg">
              <div id="healthChecklist" class="text-sm text-gray-300 space-y-2"></div>
            </div>
          </div>

          <!-- Logs Tab -->
          <div id="logsTab" class="tab-content discord-darker p-6 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-2">üìú Logs</h2>
            <p class="text-sm text-gray-400 mb-4">Env√≠a logs autom√°ticos a un canal (Firestore).</p>

            <div class="discord-dark p-4 rounded-lg">
              <div class="flex items-center justify-between mb-3">
                <label class="text-sm font-semibold">Activar logs</label>
                <input type="checkbox" id="logsEnabled" class="rounded" checked>
              </div>

              <label class="text-sm text-gray-400 block mb-1">Canal de logs</label>
              <select id="logsChannelSelect" class="w-full p-3 rounded discord-input text-white outline-none">
                <option value="">(Selecciona canal)</option>
              </select>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                <div class="flex items-center gap-2"><input type="checkbox" id="logMessageDelete" class="rounded" checked><label class="text-sm text-gray-300">Mensaje borrado</label></div>
                <div class="flex items-center gap-2"><input type="checkbox" id="logMessageEdit" class="rounded" checked><label class="text-sm text-gray-300">Mensaje editado</label></div>
                <div class="flex items-center gap-2"><input type="checkbox" id="logJoins" class="rounded" checked><label class="text-sm text-gray-300">Entradas</label></div>
                <div class="flex items-center gap-2"><input type="checkbox" id="logLeaves" class="rounded" checked><label class="text-sm text-gray-300">Salidas</label></div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                <button onclick="loadLogsSettings()" class="discord-dark px-6 py-2 rounded font-semibold hover:opacity-90">Cargar</button>
                <button onclick="saveLogsSettings()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">Guardar</button>
              </div>
            </div>
          </div>

          <!-- Verify Tab -->
          <div id="verifyTab" class="tab-content discord-darker p-6 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-2">‚úÖ Verificaci√≥n / Autoroles</h2>
            <p class="text-sm text-gray-400 mb-4">Bot√≥n "Verificarme" + roles autom√°ticos (Firestore).</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="discord-dark p-4 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                  <label class="text-sm font-semibold">Activar verificaci√≥n</label>
                  <input type="checkbox" id="verifyEnabled" class="rounded" checked>
                </div>

                <label class="text-sm text-gray-400 block mb-1">Rol al verificar (ID)</label>
                <input type="text" id="verifyRoleId" placeholder="ID del rol" class="w-full p-2 rounded discord-input text-white outline-none">

                <label class="text-sm text-gray-400 block mt-3 mb-1">Autorole al entrar (ID opcional)</label>
                <input type="text" id="verifyAutoRoleId" placeholder="ID del rol" class="w-full p-2 rounded discord-input text-white outline-none">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                  <button onclick="loadVerifySettings()" class="discord-dark px-6 py-2 rounded font-semibold hover:opacity-90">Cargar</button>
                  <button onclick="saveVerifySettings()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">Guardar</button>
                </div>
              </div>

              <div class="discord-dark p-4 rounded-lg">
                <h3 class="text-sm font-semibold mb-3">Panel de verificaci√≥n</h3>
                <label class="text-sm text-gray-400 block mb-1">T√≠tulo</label>
                <input type="text" id="verifyPanelTitle" placeholder="‚úÖ Verificaci√≥n" class="w-full p-2 rounded discord-input text-white outline-none">

                <label class="text-sm text-gray-400 block mt-3 mb-1">Descripci√≥n</label>
                <textarea id="verifyPanelDescription" rows="4" placeholder="Presiona el bot√≥n para verificarte." class="w-full p-2 rounded discord-input text-white outline-none resize-none"></textarea>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">Color</label>
                    <input type="text" id="verifyPanelColor" value="#ff2d2d" class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">Texto bot√≥n</label>
                    <input type="text" id="verifyButtonLabel" value="Verificarme" class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                </div>

                <button onclick="publishVerifyPanel()" class="mt-3 discord-blurple px-6 py-2 rounded font-semibold hover:opacity-90">Publicar Panel en Canal Seleccionado</button>
              </div>
            </div>
          </div>

          <!-- Embed Tab -->
          <div id="embedTab" class="tab-content discord-darker p-6 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-4">Crear Embed Personalizado</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label class="text-sm text-gray-400 block mb-1">T√≠tulo</label>
                <input type="text" id="embedTitle" placeholder="T√≠tulo del embed" 
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
              <div>
                <label class="text-sm text-gray-400 block mb-1">Color (hex)</label>
                <input type="text" id="embedColor" placeholder="#00ff00" value="#00ff00"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
            </div>

            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-1">Descripci√≥n</label>
              <textarea id="embedDescription" rows="4" placeholder="Descripci√≥n del embed..."
                class="w-full p-2 rounded discord-input text-white outline-none resize-none"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label class="text-sm text-gray-400 block mb-1">URL de Imagen</label>
                <input type="text" id="embedImage" placeholder="https://..."
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
              <div>
                <label class="text-sm text-gray-400 block mb-1">URL de Thumbnail</label>
                <input type="text" id="embedThumbnail" placeholder="https://..."
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label class="text-sm text-gray-400 block mb-1">Autor</label>
                <input type="text" id="embedAuthor" placeholder="Nombre del autor"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
              <div>
                <label class="text-sm text-gray-400 block mb-1">Footer</label>
                <input type="text" id="embedFooter" placeholder="Texto del footer"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
            </div>

            <!-- Fields -->
            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-2">Campos</label>
              <div id="fieldsContainer" class="space-y-2"></div>
              <button onclick="addField()" class="mt-2 text-sm text-indigo-400 hover:text-indigo-300">
                + Agregar campo
              </button>
            </div>

            <!-- Buttons -->
            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-2">Botones</label>
              <div id="buttonsContainer" class="space-y-2"></div>
              <button onclick="addButton()" class="mt-2 text-sm text-indigo-400 hover:text-indigo-300">
                + Agregar bot√≥n
              </button>
            </div>

            <div class="flex items-center gap-2 mb-4">
              <input type="checkbox" id="embedTimestamp" class="rounded">
              <label for="embedTimestamp" class="text-sm text-gray-400">Incluir timestamp</label>
            </div>

            <button onclick="sendEmbed()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">
              Enviar Embed
            </button>
          </div>

          <!-- Image Tab -->
          <div id="imageTab" class="tab-content discord-darker p-6 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-4">Enviar Imagen</h2>
            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-1">URL de la imagen</label>
              <input type="text" id="imageUrl" placeholder="https://..."
                class="w-full p-2 rounded discord-input text-white outline-none">
            </div>
            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-1">Descripci√≥n (opcional)</label>
              <input type="text" id="imageCaption" placeholder="Descripci√≥n de la imagen"
                class="w-full p-2 rounded discord-input text-white outline-none">
            </div>
            <button onclick="sendImage()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">
              Enviar Imagen
            </button>
          </div>

          <!-- Product Tab -->
          <div id="productTab" class="tab-content discord-darker p-6 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-4">üõí Plantilla de Producto</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label class="text-sm text-gray-400 block mb-1">Nombre del Producto</label>
                <input type="text" id="productName" placeholder="ANDROID HEAD"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
              <div>
                <label class="text-sm text-gray-400 block mb-1">Color</label>
                <input type="text" id="productColor" placeholder="#00ff00" value="#00ff00"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
            </div>

            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-1">Descripci√≥n del Producto</label>
              <textarea id="productDescription" rows="4" placeholder="El aimbot head consiste en..."
                class="w-full p-2 rounded discord-input text-white outline-none resize-none"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label class="text-sm text-gray-400 block mb-1">Precio Diario</label>
                <input type="text" id="productPriceDaily" placeholder="S/. 3.00 - $5.00"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
              <div>
                <label class="text-sm text-gray-400 block mb-1">Precio Mensual</label>
                <input type="text" id="productPriceMonthly" placeholder="S/. 45.00 - $15.00"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
            </div>

            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-1">URL de Imagen del Producto</label>
              <input type="text" id="productImage" placeholder="https://..."
                class="w-full p-2 rounded discord-input text-white outline-none">
            </div>

            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-1">Texto del Footer</label>
              <input type="text" id="productFooter" placeholder="‚úÖ TODO PRODUCTO SALE CON GARANT√çA Y SEGURIDAD"
                class="w-full p-2 rounded discord-input text-white outline-none">
            </div>

            <button onclick="sendProduct()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">
              Enviar Producto
            </button>
          </div>

          <!-- Tickets Tab -->
          <div id="ticketsTab" class="tab-content discord-darker p-6 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-4">üé´ Sistema de Tickets</h2>

            <div class="discord-dark p-4 rounded-lg mb-4">
              <p class="text-sm text-gray-300">
                1) Elige una <b>categor√≠a</b> donde se crear√°n los tickets
                <br>2) Elige el <b>rol staff</b> que ver√° los tickets
                <br>3) (Opcional) Elige un <b>canal de logs</b>
              </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="text-sm text-gray-400 block mb-1">Categor√≠a de Tickets</label>
                <select id="ticketCategorySelect" class="w-full p-3 rounded discord-input text-white outline-none">
                  <option value="">Selecciona un servidor primero</option>
                </select>
              </div>

              <div>
                <label class="text-sm text-gray-400 block mb-1">Rol Staff</label>
                <select id="ticketStaffRoleSelect" class="w-full p-3 rounded discord-input text-white outline-none">
                  <option value="">Selecciona un servidor primero</option>
                </select>
              </div>
            </div>

            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-1">Canal de Logs (opcional)</label>
              <select id="ticketLogChannelSelect" class="w-full p-3 rounded discord-input text-white outline-none">
                <option value="">(Sin logs)</option>
              </select>
            </div>

            <div class="flex gap-3 mb-6">
              <button onclick="saveTicketConfig()" class="discord-blurple px-6 py-2 rounded font-semibold hover:opacity-90">
                Guardar Config
              </button>
            </div>

            <h3 class="text-lg font-semibold mb-3">Personalizaci√≥n (se guarda en Firestore)</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="text-sm text-gray-400 block mb-1">Plantilla nombre del canal</label>
                <input type="text" id="ticketChannelNameTemplate" placeholder="ticket-{order}-{user}-{plan}"
                  class="w-full p-2 rounded discord-input text-white outline-none">
                <p class="text-xs text-gray-400 mt-2">Variables: {order} {user} {userId} {plan}</p>
              </div>
              <div>
                <label class="text-sm text-gray-400 block mb-1">Color embed bienvenida</label>
                <input type="text" id="ticketWelcomeColor" placeholder="#5865f2" value="#5865f2"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="text-sm text-gray-400 block mb-1">T√≠tulo embed bienvenida</label>
                <input type="text" id="ticketWelcomeTitle" placeholder="‚úÖ Ticket creado"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
              <div>
                <label class="text-sm text-gray-400 block mb-1">Campos extra (JSON opcional)</label>
                <textarea id="ticketWelcomeFieldsJson" rows="3" placeholder='[{"name":"Campo","value":"Valor","inline":true}]'
                  class="w-full p-2 rounded discord-input text-white outline-none resize-none"></textarea>
              </div>
            </div>

            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-1">Descripci√≥n embed bienvenida</label>
              <textarea id="ticketWelcomeDescription" rows="6" placeholder="Mensaje de bienvenida..."
                class="w-full p-2 rounded discord-input text-white outline-none resize-none"></textarea>
            </div>

            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-1">Mensaje inicial (texto arriba del embed)</label>
              <textarea id="ticketIntroMessage" rows="4" placeholder="Orden: **#{order}**\n<@{userId}> <@&ROL_STAFF>\n\nPlan: {plan}"
                class="w-full p-2 rounded discord-input text-white outline-none resize-none"></textarea>
              <p class="text-xs text-gray-400 mt-2">Se aplican variables: {order} {user} {userId} {plan}</p>
            </div>

            <div class="flex gap-3 mb-6">
              <button onclick="loadTicketSettings()" class="discord-dark px-6 py-2 rounded font-semibold hover:opacity-90">
                Cargar Personalizaci√≥n
              </button>
              <button onclick="saveTicketSettings()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">
                Guardar Personalizaci√≥n
              </button>
            </div>

            <h3 class="text-lg font-semibold mb-3">Publicar Panel de Tickets</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="text-sm text-gray-400 block mb-1">T√≠tulo</label>
                <input type="text" id="ticketPanelTitle" placeholder="Soporte" value="Soporte"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
              <div>
                <label class="text-sm text-gray-400 block mb-1">Texto del bot√≥n</label>
                <input type="text" id="ticketPanelButtonLabel" placeholder="Abrir ticket" value="Abrir ticket"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
            </div>

            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-1">Descripci√≥n</label>
              <textarea id="ticketPanelDescription" rows="3" placeholder="Presiona el bot√≥n para abrir un ticket."
                class="w-full p-2 rounded discord-input text-white outline-none resize-none">Presiona el bot√≥n para abrir un ticket.</textarea>
              <p class="text-xs text-gray-400 mt-2">Puedes pegar emojis personalizados aqu√≠ (incluyendo &lt;a:...&gt;).</p>
            </div>

            <button onclick="publishTicketPanel()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">
              Publicar Panel en el Canal Seleccionado
            </button>

            <hr class="my-6 border-gray-700">

            <h3 class="text-lg font-semibold mb-3">Panel Tipo Tienda (como el ejemplo)</h3>
            <p class="text-sm text-gray-400 mb-4">Env√≠a un embed con imagen y un men√∫ para elegir plan. Al elegir un plan, se crea el ticket con ese plan.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="text-sm text-gray-400 block mb-1">Color (hex)</label>
                <input type="text" id="ticketShopColor" placeholder="#00ff00" value="#00ff00"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
              <div>
                <label class="text-sm text-gray-400 block mb-1">Footer</label>
                <input type="text" id="ticketShopFooter" placeholder="‚úÖ TODO PRODUCTO SALE CON GARANT√çA"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="text-sm text-gray-400 block mb-1">URL Imagen Principal</label>
                <input type="text" id="ticketShopImage" placeholder="https://..."
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
              <div>
                <label class="text-sm text-gray-400 block mb-1">Texto del Placeholder (men√∫)</label>
                <input type="text" id="ticketShopPlaceholder" placeholder="Seleccione un Plan" value="Seleccione un Plan"
                  class="w-full p-2 rounded discord-input text-white outline-none">
              </div>
            </div>

            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-1">Descripci√≥n (embed)</label>
              <textarea id="ticketShopDescription" rows="6" placeholder="Escribe tu anuncio..."
                class="w-full p-2 rounded discord-input text-white outline-none resize-none"></textarea>
              <p class="text-xs text-gray-400 mt-2">Tip: para emojis externos pega el formato &lt;a:nombre:ID&gt; o &lt;:nombre:ID&gt;.</p>
            </div>

            <div class="mb-4">
              <label class="text-sm text-gray-400 block mb-2">Planes (dropdown)</label>
              <div id="ticketPlansContainer" class="space-y-2"></div>
              <button onclick="addTicketPlan()" class="mt-2 text-sm text-indigo-400 hover:text-indigo-300">
                + Agregar plan
              </button>
              <p class="text-xs text-gray-400 mt-2">M√°ximo 25 planes (limitaci√≥n de Discord). El campo <b>value</b> debe ser √∫nico.</p>
            </div>

            <button onclick="publishTicketShopPanel()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">
              Publicar Panel Tipo Tienda
            </button>
          </div>

          <!-- Welcome Tab -->
          <div id="welcomeTab" class="tab-content discord-darker p-6 rounded-lg hidden">
            <h2 class="text-xl font-semibold mb-2">üëã Mensaje de Bienvenida</h2>
            <p class="text-sm text-gray-400 mb-4">Configura el mensaje autom√°tico cuando alguien entra al servidor. Se guarda en Firestore.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="discord-dark p-4 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                  <label class="text-sm font-semibold">Activar Bienvenida</label>
                  <input type="checkbox" id="welcomeEnabled" class="rounded">
                </div>
                <label class="text-sm text-gray-400 block mb-1">Canal de bienvenida</label>
                <select id="welcomeChannelSelect" class="w-full p-3 rounded discord-input text-white outline-none">
                  <option value="">Selecciona un servidor primero</option>
                </select>

                <div class="flex items-center gap-2 mt-3">
                  <input type="checkbox" id="welcomePingUser" class="rounded">
                  <label for="welcomePingUser" class="text-sm text-gray-300">Mencionar al usuario ({mention})</label>
                </div>

                <div class="mt-3">
                  <label class="text-sm text-gray-400 block mb-1">Texto (opcional)</label>
                  <textarea id="welcomeContent" rows="4" placeholder="Bienvenido {mention} a {guildName}!" class="w-full p-2 rounded discord-input text-white outline-none resize-none"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                  <button onclick="loadWelcomeSettings()" class="discord-dark px-6 py-2 rounded font-semibold hover:opacity-90">Cargar</button>
                  <button onclick="saveWelcomeSettings()" class="discord-green px-6 py-2 rounded font-semibold hover:opacity-90">Guardar</button>
                </div>
              </div>

              <div class="discord-dark p-4 rounded-lg">
                <h3 class="text-sm font-semibold mb-3">Embed de bienvenida (opcional)</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">T√≠tulo</label>
                    <input type="text" id="welcomeEmbedTitle" placeholder="BIENVENIDO A {guildName}" class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">Color (hex)</label>
                    <input type="text" id="welcomeEmbedColor" placeholder="#ff2d2d" value="#ff2d2d" class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                </div>

                <div class="mb-3">
                  <label class="text-sm text-gray-400 block mb-1">Descripci√≥n</label>
                  <textarea id="welcomeEmbedDescription" rows="5" placeholder="Reglas: #reglas\nTickets: #ticket\n\nDisfruta!" class="w-full p-2 rounded discord-input text-white outline-none resize-none"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">URL Imagen (opcional)</label>
                    <input type="text" id="welcomeEmbedImage" placeholder="https://..." class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                  <div>
                    <label class="text-sm text-gray-400 block mb-1">URL Thumbnail (opcional)</label>
                    <input type="text" id="welcomeEmbedThumbnail" placeholder="https://..." class="w-full p-2 rounded discord-input text-white outline-none">
                  </div>
                </div>

                <div class="flex items-center gap-2 mb-3">
                  <input type="checkbox" id="welcomeEmbedTimestamp" class="rounded">
                  <label for="welcomeEmbedTimestamp" class="text-sm text-gray-300">Incluir timestamp</label>
                </div>

                <div class="mb-3">
                  <label class="text-sm text-gray-400 block mb-1">Borrar despu√©s (segundos, 0 = nunca)</label>
                  <input type="number" id="welcomeDeleteAfterSeconds" placeholder="0" value="0" class="w-full p-2 rounded discord-input text-white outline-none">
                </div>

                <button onclick="publishWelcomePreview()" class="discord-blurple px-6 py-2 rounded font-semibold hover:opacity-90">Publicar Preview en Canal Seleccionado</button>
              </div>
            </div>
          </div>

          <!-- Status Message -->
          <div id="statusMessage" class="mt-4 p-3 rounded hidden"></div>

        </div>
      </main>
    </div>
  </div>

  <script>
    // API base:
    // - Producci√≥n (Firebase Hosting): el backend NO vive aqu√≠, as√≠ que se configura con:
    //   1) query param ?api=https://tu-backend.com
    //   2) localStorage.dashboardApiBase
    // - Desarrollo: si abres desde otro puerto, usamos http://localhost:3000
    const qs = new URLSearchParams(window.location.search);
    const apiFromQuery = qs.get('api');
    if (apiFromQuery) {
      localStorage.setItem('dashboardApiBase', apiFromQuery);
    }
    const storedApi = localStorage.getItem('dashboardApiBase');
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const DEFAULT_API_BASE = 'http://localhost:3000';
    const API_BASE = storedApi ? storedApi : DEFAULT_API_BASE;

    let lastFocusedField = null;

    function toggleHelpers() {
      const el = document.getElementById('helpersPanel');
      if (!el) return;
      el.classList.toggle('hidden');
    }

    function insertPlaceholder(text) {
      const el = lastFocusedField;
      if (!el || (typeof el.value !== 'string')) {
        showStatus('Selecciona un campo primero (click en un input/textarea).', true);
        return;
      }

      const start = el.selectionStart ?? el.value.length;
      const end = el.selectionEnd ?? el.value.length;
      const before = el.value.slice(0, start);
      const after = el.value.slice(end);
      el.value = before + text + after;
      try {
        el.focus();
        const pos = start + text.length;
        el.setSelectionRange(pos, pos);
      } catch (e) {}
    }

    function applyPreset(preset) {
      if (preset === 'ticket-default') {
        const channelTpl = document.getElementById('ticketChannelNameTemplate');
        const welcomeTitle = document.getElementById('ticketWelcomeTitle');
        const welcomeColor = document.getElementById('ticketWelcomeColor');
        const welcomeDesc = document.getElementById('ticketWelcomeDescription');
        const intro = document.getElementById('ticketIntroMessage');
        if (channelTpl && !channelTpl.value) channelTpl.value = 'ticket-{order}-{user}-{plan}';
        if (welcomeTitle && !welcomeTitle.value) welcomeTitle.value = '‚úÖ Ticket creado';
        if (welcomeColor && (!welcomeColor.value || welcomeColor.value === '#5865f2')) welcomeColor.value = '#ff2d2d';
        if (welcomeDesc && !welcomeDesc.value) welcomeDesc.value = 'Hola {user} üëã\n\nCu√©ntanos tu problema y un staff te ayudar√°.';
        if (intro && !intro.value) intro.value = 'Orden: **#{order}**\n<@{userId}>\n\nPlan: {plan}';
        showStatus('Plantilla de tickets aplicada. Revisa y guarda la personalizaci√≥n.', false);
        return;
      }

      if (preset === 'shop-default') {
        const color = document.getElementById('ticketShopColor');
        const footer = document.getElementById('ticketShopFooter');
        const placeholder = document.getElementById('ticketShopPlaceholder');
        const desc = document.getElementById('ticketShopDescription');
        if (color && (!color.value || color.value === '#00ff00')) color.value = '#ff2d2d';
        if (footer && !footer.value) footer.value = '‚úÖ Compra segura | Soporte 24/7';
        if (placeholder && !placeholder.value) placeholder.value = 'Seleccione un Plan';
        if (desc && !desc.value) desc.value = 'Elige un plan del men√∫ para abrir un ticket autom√°ticamente.';
        showStatus('Plantilla de panel tienda aplicada.', false);
        return;
      }

      if (preset === 'embed-default') {
        const title = document.getElementById('embedTitle');
        const color = document.getElementById('embedColor');
        const desc = document.getElementById('embedDescription');
        const footer = document.getElementById('embedFooter');
        if (title && !title.value) title.value = 'üìå Anuncio';
        if (color && (!color.value || color.value === '#00ff00')) color.value = '#ff2d2d';
        if (desc && !desc.value) desc.value = 'Escribe aqu√≠ tu anuncio...';
        if (footer && !footer.value) footer.value = 'Servidor: {guildId}';
        showStatus('Plantilla de embed aplicada.', false);
        return;
      }

      if (preset === 'welcome-default') {
        const enabled = document.getElementById('welcomeEnabled');
        const ping = document.getElementById('welcomePingUser');
        const content = document.getElementById('welcomeContent');
        const title = document.getElementById('welcomeEmbedTitle');
        const color = document.getElementById('welcomeEmbedColor');
        const desc = document.getElementById('welcomeEmbedDescription');
        const del = document.getElementById('welcomeDeleteAfterSeconds');
        if (enabled) enabled.checked = true;
        if (ping) ping.checked = true;
        if (content && !content.value) content.value = 'welcome {mention}';
        if (title && !title.value) title.value = 'BIENVENIDO A {guildName}';
        if (color && (!color.value || color.value === '#00ff00')) color.value = '#ff2d2d';
        if (desc && !desc.value) desc.value = '‚úÖ Reglas: #reglas\n‚úÖ Server: #server\n\nüé´ Soporte: #ticket';
        if (del && (!del.value || del.value === '0')) del.value = '0';
        showStatus('Plantilla de bienvenida aplicada.', false);
        return;
      }

      if (preset === 'moderation-default') {
        const enabled = document.getElementById('modEnabled');
        const blockLinks = document.getElementById('modBlockLinks');
        const blockInvites = document.getElementById('modBlockInvites');
        const whitelist = document.getElementById('modWhitelist');
        const spamEnabled = document.getElementById('spamEnabled');
        const spamWindowMs = document.getElementById('spamWindowMs');
        const spamMaxMsgs = document.getElementById('spamMaxMsgs');
        const spamTimeoutMs = document.getElementById('spamTimeoutMs');
        if (enabled) enabled.checked = true;
        if (blockLinks) blockLinks.checked = true;
        if (blockInvites) blockInvites.checked = true;
        if (whitelist && !whitelist.value) whitelist.value = 'youtube.com\ndiscord.com\ngithub.com';
        if (spamEnabled) spamEnabled.checked = true;
        if (spamWindowMs && !spamWindowMs.value) spamWindowMs.value = '7000';
        if (spamMaxMsgs && !spamMaxMsgs.value) spamMaxMsgs.value = '6';
        if (spamTimeoutMs && !spamTimeoutMs.value) spamTimeoutMs.value = '60000';
        showStatus('Plantilla de moderaci√≥n aplicada.', false);
        return;
      }

      if (preset === 'logs-default') {
        const enabled = document.getElementById('logsEnabled');
        const d = document.getElementById('logMessageDelete');
        const e = document.getElementById('logMessageEdit');
        const j = document.getElementById('logJoins');
        const l = document.getElementById('logLeaves');
        if (enabled) enabled.checked = true;
        if (d) d.checked = true;
        if (e) e.checked = true;
        if (j) j.checked = true;
        if (l) l.checked = true;
        showStatus('Plantilla de logs aplicada.', false);
        return;
      }

      if (preset === 'verify-default') {
        const enabled = document.getElementById('verifyEnabled');
        const title = document.getElementById('verifyPanelTitle');
        const desc = document.getElementById('verifyPanelDescription');
        const color = document.getElementById('verifyPanelColor');
        const btn = document.getElementById('verifyButtonLabel');
        if (enabled) enabled.checked = true;
        if (title && !title.value) title.value = '‚úÖ Verificaci√≥n';
        if (desc && !desc.value) desc.value = 'Presiona el bot√≥n para verificarte.';
        if (color && (!color.value || color.value === '#00ff00')) color.value = '#ff2d2d';
        if (btn && !btn.value) btn.value = 'Verificarme';
        showStatus('Plantilla de verificaci√≥n aplicada.', false);
        return;
      }

      if (preset === 'raid-default') {
        const enabled = document.getElementById('raidEnabled');
        const w = document.getElementById('raidJoinWindowMs');
        const t = document.getElementById('raidJoinThreshold');
        const d = document.getElementById('raidDefenseDurationMs');
        const s = document.getElementById('raidSlowmodeSeconds');
        if (enabled) enabled.checked = true;
        if (w && !w.value) w.value = '15000';
        if (t && !t.value) t.value = '8';
        if (d && !d.value) d.value = '300000';
        if (s && !s.value) s.value = '10';
        showStatus('Plantilla de anti-raid aplicada.', false);
        return;
      }
    }

    async function exportBackup() {
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);
      try {
        const res = await fetch(`${API_BASE}/api/backup/export?guildId=${encodeURIComponent(selectedGuild)}`, {
          headers: { 'Authorization': token }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) return showStatus('‚ùå ' + (data.error || 'Error al exportar'), true);
        const el = document.getElementById('backupJson');
        if (el) el.value = JSON.stringify(data.export || {}, null, 2);
        showStatus('‚úÖ Backup exportado');
      } catch (err) {
        showStatus('‚ùå Error al exportar', true);
      }
    }

    async function importBackup() {
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);
      const el = document.getElementById('backupJson');
      const raw = el ? el.value.trim() : '';
      if (!raw) return showStatus('Pega un JSON primero', true);

      let exportData = null;
      try {
        exportData = JSON.parse(raw);
      } catch (e) {
        return showStatus('JSON inv√°lido', true);
      }

      try {
        const res = await fetch(`${API_BASE}/api/backup/import`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, exportData })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) return showStatus('‚ùå ' + (data.error || 'Error al importar'), true);
        showStatus('‚úÖ Backup importado');
      } catch (err) {
        showStatus('‚ùå Error al importar', true);
      }
    }

    async function healthCheck() {
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);
      try {
        const res = await fetch(`${API_BASE}/api/healthcheck/guild?guildId=${encodeURIComponent(selectedGuild)}`, {
          headers: { 'Authorization': token }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) return showStatus('‚ùå ' + (data.error || 'Error al consultar salud'), true);

        const el = document.getElementById('healthChecklist');
        if (!el) return;

        const item = (ok, label) => {
          const badge = ok
            ? '<span class="text-xs px-2 py-1 rounded bg-green-500/20 text-green-400">OK</span>'
            : '<span class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400">FALTA</span>';
          return `<div class="flex items-center justify-between gap-3"><div>${label}</div>${badge}</div>`;
        };

        el.innerHTML = [
          item(Boolean(data.setup), 'Setup aplicado'),
          item(Boolean(data.moderation), 'Moderaci√≥n configurada'),
          item(Boolean(data.logs), 'Logs configurados'),
          item(Boolean(data.verify), 'Verificaci√≥n configurada'),
          item(Boolean(data.welcome), 'Bienvenida configurada'),
          item(Boolean(data.tickets), 'Tickets configurados'),
        ].join('');

        showStatus('‚úÖ Salud actualizada');
      } catch (err) {
        showStatus('‚ùå Error al consultar salud', true);
      }
    }

    function renderSetupActions(plan) {
      const el = document.getElementById('setupActions');
      if (!el) return;

      const actions = Array.isArray(plan?.actions) ? plan.actions : [];
      if (!actions.length) {
        el.innerHTML = '<div class="text-gray-400">(Sin acciones)</div>';
        return;
      }

      const badge = (exists) => exists
        ? '<span class="text-xs px-2 py-1 rounded bg-green-500/20 text-green-400">EXISTE</span>'
        : '<span class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400">CREAR</span>';

      el.innerHTML = actions.map(a => {
        const label = a.type === 'category'
          ? `Categor√≠a: ${a.name}`
          : a.type === 'role'
            ? `Rol: ${a.name}`
            : `Canal: ${a.name} ‚Üí ${a.categoryKey || ''}`;
        return `<div class="flex items-center justify-between gap-3"><div class="truncate">${label}</div>${badge(a.exists)}</div>`;
      }).join('');
    }

    async function setupPreview() {
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);

      try {
        const res = await fetch(`${API_BASE}/api/setup/plan`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) return showStatus('‚ùå ' + (data.error || 'No se pudo generar preview'), true);

        renderSetupActions(data.plan);
        showStatus('‚úÖ Preview generado');
      } catch (err) {
        showStatus('‚ùå Error al generar preview', true);
      }
    }

    async function setupApply() {
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);

      try {
        const res = await fetch(`${API_BASE}/api/setup/apply`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) return showStatus('‚ùå ' + (data.error || 'No se pudo aplicar setup'), true);

        showStatus('‚úÖ Setup aplicado (canales/roles/mensajes base)');

        await loadGuilds();
        if (selectedGuild) await selectGuild(selectedGuild, '');
        await setupPreview();
      } catch (err) {
        showStatus('‚ùå Error al aplicar setup', true);
      }
    }

    document.addEventListener('focusin', (e) => {
      const t = e.target;
      if (!t) return;
      const tag = (t.tagName || '').toLowerCase();
      if (tag === 'input' || tag === 'textarea') {
        lastFocusedField = t;
      }
    });
    let selectedGuild = null;
    let token = localStorage.getItem('dashboardToken') || null;

    async function safeReadJson(res) {
      const ct = (res.headers.get('content-type') || '').toLowerCase();
      if (ct.includes('application/json')) return await res.json();
      const text = await res.text();
      return { __nonJson: true, text };
    }

    // Check if already logged in
    if (token) {
      checkAuth();
    }

    async function login() {
      const password = document.getElementById('passwordInput').value;

      if (!API_BASE && !isLocal) {
        showStatus('Configura el backend: abre con ?api=https://TU_BACKEND.com', true);
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await safeReadJson(res);
        if (data && data.__nonJson) {
          showStatus('El backend no respondi√≥ JSON. Revisa ?api= o que el backend est√© online.', true);
          return;
        }

        if (data && data.success) {
          token = data.token;
          localStorage.setItem('dashboardToken', token);
          showDashboard();
        } else {
          document.getElementById('loginError').classList.remove('hidden');
        }
      } catch (err) {
        console.error(err);
      }
    }

    function addTicketPlan(prefill = null) {
      const container = document.getElementById('ticketPlansContainer');
      const div = document.createElement('div');
      div.className = 'grid grid-cols-1 md:grid-cols-5 gap-2 items-center';
      div.innerHTML = `
        <input type="text" placeholder="Label (ej: Panel Vip 1 Semana)" class="p-2 rounded discord-input text-white outline-none tp-label">
        <input type="text" placeholder="Value (ej: vip_semana)" class="p-2 rounded discord-input text-white outline-none tp-value">
        <input type="text" placeholder="Descripci√≥n (ej: Precio S/.25 - $9.50)" class="p-2 rounded discord-input text-white outline-none tp-desc">
        <input type="text" placeholder="Emoji (opcional)" class="p-2 rounded discord-input text-white outline-none tp-emoji">
        <button onclick="this.parentElement.remove()" class="text-red-400 px-2">‚úï</button>
      `;
      container.appendChild(div);

      if (prefill) {
        div.querySelector('.tp-label').value = prefill.label || '';
        div.querySelector('.tp-value').value = prefill.value || '';
        div.querySelector('.tp-desc').value = prefill.description || '';
        div.querySelector('.tp-emoji').value = prefill.emoji || '';
      }
    }

    async function publishTicketShopPanel() {
      const channelId = document.getElementById('channelSelect').value;
      if (!channelId) return showStatus('Selecciona un canal', true);

      const embed = {
        title: document.getElementById('ticketPanelTitle').value || 'Soporte',
        description: document.getElementById('ticketShopDescription').value || 'Seleccione un plan para abrir su ticket.',
        color: document.getElementById('ticketShopColor').value || '#00ff00',
        image: document.getElementById('ticketShopImage').value || null,
        footer: document.getElementById('ticketShopFooter').value || null,
      };

      const placeholder = document.getElementById('ticketShopPlaceholder').value || 'Seleccione un Plan';

      const plans = [];
      document.querySelectorAll('#ticketPlansContainer > div').forEach(div => {
        const label = div.querySelector('.tp-label').value;
        const value = div.querySelector('.tp-value').value;
        const description = div.querySelector('.tp-desc').value;
        const emoji = div.querySelector('.tp-emoji').value;
        if (label && value) {
          plans.push({ label, value, description, emoji });
        }
      });

      if (plans.length === 0) return showStatus('Agrega al menos 1 plan (label + value)', true);

      try {
        const res = await fetch(`${API_BASE}/api/tickets/shop-panel`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ channelId, embed, plans, placeholder })
        });

        if (res.ok) {
          showStatus('‚úÖ Panel tipo tienda publicado');
        } else {
          const data = await res.json();
          showStatus('‚ùå ' + (data.error || 'Error al publicar panel'), true);
        }
      } catch (err) {
        showStatus('‚ùå Error al publicar panel', true);
      }
    }

    // Defaults bonitos para que ya tengas ejemplo al abrir
    if (document.getElementById('ticketPlansContainer') && document.getElementById('ticketPlansContainer').children.length === 0) {
      addTicketPlan({ label: 'Panel Vip 1 Semana', value: 'vip_semana', description: 'Precio: S/. 25.00 - $9.50', emoji: 'üóìÔ∏è' });
      addTicketPlan({ label: 'Panel Vip 1 Mes', value: 'vip_mes', description: 'Precio: S/. 70.00 - $20.00', emoji: 'üìÖ' });
      addTicketPlan({ label: 'Panel Vip Anual', value: 'vip_anual', description: 'Precio: S/. 300.00 - $87.00', emoji: 'üèÜ' });
    }

    async function checkAuth() {
      try {
        const res = await fetch(`${API_BASE}/api/bot-info`, {
          headers: { 'Authorization': token }
        });
        if (res.ok) {
          showDashboard();
        } else {
          localStorage.removeItem('dashboardToken');
        }
      } catch (err) {
        localStorage.removeItem('dashboardToken');
      }
    }

    async function showDashboard() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      await loadBotInfo();
      await loadGuilds();
    }

    async function loadBotInfo() {
      const res = await fetch(`${API_BASE}/api/bot-info`, { headers: { 'Authorization': token } });
      const data = await res.json();
      document.getElementById('botAvatar').src = data.avatar;
      document.getElementById('botName').textContent = data.username;
      document.getElementById('guildCount').textContent = data.guilds;
    }

    async function loadGuilds() {
      const res = await fetch(`${API_BASE}/api/guilds`, { headers: { 'Authorization': token } });
      const guilds = await res.json();
      const container = document.getElementById('guildList');
      container.innerHTML = guilds.map(g => `
        <div onclick="selectGuild('${g.id}', '${g.name}')" 
          class="guild-item flex items-center gap-2 p-2 rounded cursor-pointer hover:bg-gray-700 transition ${selectedGuild === g.id ? 'bg-gray-700' : ''}">
          <img src="${g.icon || 'https://cdn.discordapp.com/embed/avatars/0.png'}" class="w-8 h-8 rounded-full">
          <span class="text-sm truncate">${g.name}</span>
        </div>
      `).join('');
    }

    async function selectGuild(guildId, guildName) {
      selectedGuild = guildId;
      loadGuilds();
      const res = await fetch(`${API_BASE}/api/guilds/${guildId}/channels`, { headers: { 'Authorization': token } });
      const channels = await res.json();
      const select = document.getElementById('channelSelect');
      select.innerHTML = channels.map(c => {
        const disabled = c.canSend === false ? 'disabled' : '';
        const prefix = c.typeName ? `[${c.typeName}] ` : '';
        const label = c.canSend === false
          ? `${prefix}${c.name} (no enviable)`
          : `${prefix}# ${c.name}`;
        return `<option value="${c.id}" ${disabled}>${label}</option>`;
      }).join('');

      // Cargar data para Tickets
      await loadTicketOptions(guildId);

      // Cargar data para Bienvenida
      loadWelcomeChannelOptionsFromChannels(channels);

      // Cargar data para selects de moderaci√≥n/logs
      loadLogChannelOptionsFromChannels(channels);

      // Select de logs para anti-raid
      loadRaidLogChannelOptionsFromChannels(channels);
    }

    function loadLogChannelOptionsFromChannels(channels) {
      const logSelect = document.getElementById('logsChannelSelect');
      const modLogSelect = document.getElementById('modLogChannelSelect');
      const opts = Array.isArray(channels)
        ? channels.filter(c => c && c.canSend !== false && (c.typeName === 'text' || c.typeName === 'announcement' || c.type === 0 || c.type === 5))
        : [];

      const html = opts.length
        ? `<option value="">(Selecciona canal)</option>` + opts.map(c => `<option value="${c.id}"># ${c.name}</option>`).join('')
        : '<option value="">(No hay canales de texto)</option>';

      if (logSelect) logSelect.innerHTML = html;
      if (modLogSelect) modLogSelect.innerHTML = `<option value="">(Sin logs)</option>` + (opts.map(c => `<option value="${c.id}"># ${c.name}</option>`).join(''));
    }

    function loadRaidLogChannelOptionsFromChannels(channels) {
      const raidSelect = document.getElementById('raidLogChannelSelect');
      if (!raidSelect) return;
      const opts = Array.isArray(channels)
        ? channels.filter(c => c && c.canSend !== false && (c.typeName === 'text' || c.typeName === 'announcement' || c.type === 0 || c.type === 5))
        : [];
      raidSelect.innerHTML = `<option value="">(Sin logs)</option>` + opts.map(c => `<option value="${c.id}"># ${c.name}</option>`).join('');
    }

    async function loadModerationSettings(guildIdOverride = null) {
      const guildId = guildIdOverride || selectedGuild;
      if (!guildId) return;

      try {
        const res = await fetch(`${API_BASE}/api/settings/moderation?guildId=${encodeURIComponent(guildId)}`, {
          headers: { 'Authorization': token }
        });
        const data = res.ok ? await res.json() : {};

        document.getElementById('modEnabled').checked = data.enabled !== false;
        document.getElementById('modBlockLinks').checked = Boolean(data.blockLinks);
        document.getElementById('modBlockInvites').checked = Boolean(data.blockInvites);
        document.getElementById('spamEnabled').checked = data.spamEnabled !== false;
        document.getElementById('spamWindowMs').value = String(data.spamWindowMs || 7000);
        document.getElementById('spamMaxMsgs').value = String(data.spamMaxMsgs || 6);
        document.getElementById('spamTimeoutMs').value = String(data.spamTimeoutMs || 60000);
        document.getElementById('modWhitelist').value = Array.isArray(data.whitelistDomains) ? data.whitelistDomains.join('\n') : '';
        document.getElementById('modExemptRoleIds').value = Array.isArray(data.exemptRoleIds) ? data.exemptRoleIds.join(',') : '';
        document.getElementById('modExemptChannelIds').value = Array.isArray(data.exemptChannelIds) ? data.exemptChannelIds.join(',') : '';
        document.getElementById('modLogChannelSelect').value = data.logChannelId || '';

        showStatus('‚úÖ Moderaci√≥n cargada');
      } catch (err) {
        showStatus('‚ùå No se pudo cargar moderaci√≥n', true);
      }
    }

    async function saveModerationSettings() {
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);

      const whitelistDomains = document.getElementById('modWhitelist').value
        .split('\n')
        .map(s => s.trim())
        .filter(Boolean);

      const exemptRoleIds = document.getElementById('modExemptRoleIds').value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);

      const exemptChannelIds = document.getElementById('modExemptChannelIds').value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);

      const settings = {
        enabled: document.getElementById('modEnabled').checked,
        blockLinks: document.getElementById('modBlockLinks').checked,
        blockInvites: document.getElementById('modBlockInvites').checked,
        whitelistDomains,
        exemptRoleIds,
        exemptChannelIds,
        spamEnabled: document.getElementById('spamEnabled').checked,
        spamWindowMs: Number(document.getElementById('spamWindowMs').value || 7000),
        spamMaxMsgs: Number(document.getElementById('spamMaxMsgs').value || 6),
        spamTimeoutMs: Number(document.getElementById('spamTimeoutMs').value || 60000),
        logChannelId: document.getElementById('modLogChannelSelect').value || null,
      };

      try {
        const res = await fetch(`${API_BASE}/api/settings/moderation`, {
          method: 'PUT',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, settings })
        });
        if (res.ok) {
          showStatus('‚úÖ Moderaci√≥n guardada');
        } else {
          const data = await res.json().catch(() => ({}));
          showStatus('‚ùå ' + (data.error || 'Error al guardar'), true);
        }
      } catch (err) {
        showStatus('‚ùå Error al guardar moderaci√≥n', true);
      }
    }

    async function loadLogsSettings(guildIdOverride = null) {
      const guildId = guildIdOverride || selectedGuild;
      if (!guildId) return;

      try {
        const res = await fetch(`${API_BASE}/api/settings/logs?guildId=${encodeURIComponent(guildId)}`, {
          headers: { 'Authorization': token }
        });
        const data = res.ok ? await res.json() : {};

        document.getElementById('logsEnabled').checked = data.enabled !== false;
        document.getElementById('logsChannelSelect').value = data.channelId || '';
        document.getElementById('logMessageDelete').checked = Boolean(data.logMessageDelete);
        document.getElementById('logMessageEdit').checked = Boolean(data.logMessageEdit);
        document.getElementById('logJoins').checked = Boolean(data.logJoins);
        document.getElementById('logLeaves').checked = Boolean(data.logLeaves);

        showStatus('‚úÖ Logs cargados');
      } catch (err) {
        showStatus('‚ùå No se pudo cargar logs', true);
      }
    }

    async function saveLogsSettings() {
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);

      const settings = {
        enabled: document.getElementById('logsEnabled').checked,
        channelId: document.getElementById('logsChannelSelect').value || null,
        logMessageDelete: document.getElementById('logMessageDelete').checked,
        logMessageEdit: document.getElementById('logMessageEdit').checked,
        logJoins: document.getElementById('logJoins').checked,
        logLeaves: document.getElementById('logLeaves').checked,
      };

      try {
        const res = await fetch(`${API_BASE}/api/settings/logs`, {
          method: 'PUT',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, settings })
        });

        if (res.ok) {
          showStatus('‚úÖ Logs guardados');
        } else {
          const data = await res.json().catch(() => ({}));
          showStatus('‚ùå ' + (data.error || 'Error al guardar logs'), true);
        }
      } catch (err) {
        showStatus('‚ùå Error al guardar logs', true);
      }
    }

    async function loadVerifySettings(guildIdOverride = null) {
      const guildId = guildIdOverride || selectedGuild;
      if (!guildId) return;

      try {
        const res = await fetch(`${API_BASE}/api/settings/verify?guildId=${encodeURIComponent(guildId)}`, {
          headers: { 'Authorization': token }
        });
        const data = res.ok ? await res.json() : {};

        document.getElementById('verifyEnabled').checked = data.enabled !== false;
        document.getElementById('verifyRoleId').value = data.roleId || '';
        document.getElementById('verifyAutoRoleId').value = data.autoRoleId || '';
        document.getElementById('verifyPanelTitle').value = data.panelTitle || '';
        document.getElementById('verifyPanelDescription').value = data.panelDescription || '';
        document.getElementById('verifyPanelColor').value = data.panelColor || '#ff2d2d';
        document.getElementById('verifyButtonLabel').value = data.buttonLabel || 'Verificarme';

        showStatus('‚úÖ Verificaci√≥n cargada');
      } catch (err) {
        showStatus('‚ùå No se pudo cargar verificaci√≥n', true);
      }
    }

    async function saveVerifySettings() {
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);

      const settings = {
        enabled: document.getElementById('verifyEnabled').checked,
        roleId: document.getElementById('verifyRoleId').value.trim() || null,
        autoRoleId: document.getElementById('verifyAutoRoleId').value.trim() || null,
        panelTitle: document.getElementById('verifyPanelTitle').value || '‚úÖ Verificaci√≥n',
        panelDescription: document.getElementById('verifyPanelDescription').value || 'Presiona el bot√≥n para verificarte.',
        panelColor: document.getElementById('verifyPanelColor').value || '#ff2d2d',
        buttonLabel: document.getElementById('verifyButtonLabel').value || 'Verificarme',
      };

      try {
        const res = await fetch(`${API_BASE}/api/settings/verify`, {
          method: 'PUT',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, settings })
        });
        if (res.ok) {
          showStatus('‚úÖ Verificaci√≥n guardada');
        } else {
          const data = await res.json().catch(() => ({}));
          showStatus('‚ùå ' + (data.error || 'Error al guardar verificaci√≥n'), true);
        }
      } catch (err) {
        showStatus('‚ùå Error al guardar verificaci√≥n', true);
      }
    }

    async function publishVerifyPanel() {
      const channelId = document.getElementById('channelSelect')?.value;
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);
      if (!channelId) return showStatus('Selecciona un canal', true);

      try {
        const res = await fetch(`${API_BASE}/api/verify/panel`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, channelId })
        });
        if (res.ok) {
          showStatus('‚úÖ Panel de verificaci√≥n publicado');
        } else {
          const data = await res.json().catch(() => ({}));
          showStatus('‚ùå ' + (data.error || 'Error al publicar panel'), true);
        }
      } catch (err) {
        showStatus('‚ùå Error al publicar panel', true);
      }
    }

    function loadWelcomeChannelOptionsFromChannels(channels) {
      const welcomeSelect = document.getElementById('welcomeChannelSelect');
      if (!welcomeSelect) return;
      const textChannels = Array.isArray(channels)
        ? channels.filter(c => c && c.canSend !== false && (c.typeName === 'text' || c.typeName === 'announcement' || c.type === 0 || c.type === 5))
        : [];
      welcomeSelect.innerHTML = textChannels.length
        ? `<option value="">(Selecciona un canal)</option>` + textChannels.map(c => `<option value="${c.id}"># ${c.name}</option>`).join('')
        : '<option value="">(No hay canales de texto)</option>';
    }

    async function loadTicketOptions(guildId) {
      try {
        const [rolesRes, catsRes, chansRes] = await Promise.all([
          fetch(`${API_BASE}/api/guilds/${guildId}/roles`, { headers: { 'Authorization': token } }),
          fetch(`${API_BASE}/api/guilds/${guildId}/categories`, { headers: { 'Authorization': token } }),
          fetch(`${API_BASE}/api/guilds/${guildId}/channels`, { headers: { 'Authorization': token } }),
        ]);

        const roles = rolesRes.ok ? await rolesRes.json() : [];
        const categories = catsRes.ok ? await catsRes.json() : [];
        const channels = chansRes.ok ? await chansRes.json() : [];

        const catSelect = document.getElementById('ticketCategorySelect');
        catSelect.innerHTML = categories.length
          ? categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')
          : '<option value="">(No hay categor√≠as)</option>';

        const roleSelect = document.getElementById('ticketStaffRoleSelect');
        roleSelect.innerHTML = roles.length
          ? roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('')
          : '<option value="">(No hay roles)</option>';

        const logSelect = document.getElementById('ticketLogChannelSelect');
        logSelect.innerHTML = `<option value="">(Sin logs)</option>` + channels.map(c => `<option value="${c.id}"># ${c.name}</option>`).join('');

        await loadTicketSettings(guildId);
      } catch (err) {
        showStatus('‚ùå No se pudo cargar roles/categor√≠as para tickets', true);
      }
    }

    async function loadTicketSettings(guildIdOverride = null) {
      const guildId = guildIdOverride || selectedGuild;
      if (!guildId) return;

      try {
        const res = await fetch(`${API_BASE}/api/settings/tickets?guildId=${encodeURIComponent(guildId)}`, {
          headers: { 'Authorization': token }
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          return showStatus('‚ùå ' + (data.error || 'No se pudo cargar personalizaci√≥n'), true);
        }

        const data = await res.json();

        document.getElementById('ticketChannelNameTemplate').value = data.channelNameTemplate || '';
        document.getElementById('ticketIntroMessage').value = data.introMessage || '';

        const we = data.welcomeEmbed || {};
        document.getElementById('ticketWelcomeTitle').value = we.title || '';
        document.getElementById('ticketWelcomeDescription').value = we.description || '';
        document.getElementById('ticketWelcomeColor').value = we.color || '#5865f2';
        document.getElementById('ticketWelcomeFieldsJson').value = we.fields ? JSON.stringify(we.fields, null, 2) : '';
      } catch (err) {
        showStatus('‚ùå Error al guardar personalizaci√≥n', true);
      }
    }

    async function saveTicketSettings() {
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);

      let fields = null;
      const rawFields = document.getElementById('ticketWelcomeFieldsJson').value.trim();
      if (rawFields) {
        try {
          fields = JSON.parse(rawFields);
        } catch (err) {
          return showStatus('‚ùå Campos extra JSON inv√°lido', true);
        }
      }

      const settings = {
        channelNameTemplate: document.getElementById('ticketChannelNameTemplate').value.trim() || null,
        introMessage: document.getElementById('ticketIntroMessage').value || null,
        welcomeEmbed: {
          title: document.getElementById('ticketWelcomeTitle').value || null,
          description: document.getElementById('ticketWelcomeDescription').value || null,
          color: document.getElementById('ticketWelcomeColor').value || '#5865f2',
          fields: fields || undefined,
        }
      };

      try {
        const res = await fetch(`${API_BASE}/api/settings/tickets`, {
          method: 'PUT',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, settings })
        });

        if (res.ok) {
          showStatus('‚úÖ Personalizaci√≥n guardada');
        } else {
          const data = await res.json().catch(() => ({}));
          showStatus('‚ùå ' + (data.error || 'Error al guardar'), true);
        }
      } catch (err) {
        showStatus('‚ùå Error al guardar', true);
      }
    }

    async function loadWelcomeSettings(guildIdOverride = null) {
      const guildId = guildIdOverride || selectedGuild;
      if (!guildId) return;

      try {
        const res = await fetch(`${API_BASE}/api/settings/welcome?guildId=${encodeURIComponent(guildId)}`, {
          headers: { 'Authorization': token }
        });

        const data = res.ok ? await res.json() : {};

        const enabledEl = document.getElementById('welcomeEnabled');
        if (enabledEl) enabledEl.checked = data.enabled !== false;

        const pingEl = document.getElementById('welcomePingUser');
        if (pingEl) pingEl.checked = Boolean(data.pingUser);

        const contentEl = document.getElementById('welcomeContent');
        if (contentEl) contentEl.value = data.content || '';

        const channelEl = document.getElementById('welcomeChannelSelect');
        if (channelEl && data.channelId) channelEl.value = data.channelId;

        const embed = data.embed || {};
        const titleEl = document.getElementById('welcomeEmbedTitle');
        if (titleEl) titleEl.value = embed.title || '';
        const colorEl = document.getElementById('welcomeEmbedColor');
        if (colorEl) colorEl.value = embed.color || '#ff2d2d';
        const descEl = document.getElementById('welcomeEmbedDescription');
        if (descEl) descEl.value = embed.description || '';
        const imgEl = document.getElementById('welcomeEmbedImage');
        if (imgEl) imgEl.value = embed.image || '';
        const thumbEl = document.getElementById('welcomeEmbedThumbnail');
        if (thumbEl) thumbEl.value = embed.thumbnail || '';
        const tsEl = document.getElementById('welcomeEmbedTimestamp');
        if (tsEl) tsEl.checked = Boolean(embed.timestamp);

        const delEl = document.getElementById('welcomeDeleteAfterSeconds');
        if (delEl) delEl.value = String(data.deleteAfterSeconds || 0);

        showStatus('‚úÖ Bienvenida cargada');
      } catch (err) {
        showStatus('‚ùå No se pudo cargar bienvenida', true);
      }
    }

    async function saveWelcomeSettings() {
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);

      const settings = {
        enabled: document.getElementById('welcomeEnabled')?.checked ?? true,
        channelId: document.getElementById('welcomeChannelSelect')?.value || null,
        pingUser: document.getElementById('welcomePingUser')?.checked ?? false,
        content: document.getElementById('welcomeContent')?.value || '',
        deleteAfterSeconds: Number(document.getElementById('welcomeDeleteAfterSeconds')?.value || 0),
        embed: {
          title: document.getElementById('welcomeEmbedTitle')?.value || '',
          color: document.getElementById('welcomeEmbedColor')?.value || '#ff2d2d',
          description: document.getElementById('welcomeEmbedDescription')?.value || '',
          image: document.getElementById('welcomeEmbedImage')?.value || '',
          thumbnail: document.getElementById('welcomeEmbedThumbnail')?.value || '',
          timestamp: document.getElementById('welcomeEmbedTimestamp')?.checked ?? false,
        }
      };

      try {
        const res = await fetch(`${API_BASE}/api/settings/welcome`, {
          method: 'PUT',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, settings })
        });

        if (res.ok) {
          showStatus('‚úÖ Bienvenida guardada');
        } else {
          const data = await res.json().catch(() => ({}));
          showStatus('‚ùå ' + (data.error || 'Error al guardar bienvenida'), true);
        }
      } catch (err) {
        showStatus('‚ùå Error al guardar bienvenida', true);
      }
    }

    async function publishWelcomePreview() {
      const channelId = document.getElementById('channelSelect')?.value;
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);
      if (!channelId) return showStatus('Selecciona un canal', true);

      try {
        const res = await fetch(`${API_BASE}/api/welcome/publish`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, channelId })
        });

        if (res.ok) {
          showStatus('‚úÖ Preview de bienvenida publicado');
        } else {
          const data = await res.json().catch(() => ({}));
          showStatus('‚ùå ' + (data.error || 'Error al publicar preview'), true);
        }
      } catch (err) {
        showStatus('‚ùå Error al publicar preview', true);
      }
    }

    async function saveTicketConfig() {
      const ticketCategoryId = document.getElementById('ticketCategorySelect').value;
      const ticketStaffRoleId = document.getElementById('ticketStaffRoleSelect').value;
      const logChannelId = document.getElementById('ticketLogChannelSelect').value;

      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);
      if (!ticketCategoryId || !ticketStaffRoleId) return showStatus('Selecciona categor√≠a y rol staff', true);

      try {
        const res = await fetch(`${API_BASE}/api/tickets/config`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticketCategoryId, ticketStaffRoleId, logChannelId })
        });

        if (res.ok) {
          showStatus('‚úÖ Config de tickets guardada (mientras el bot est√© encendido)');
        } else {
          const data = await res.json();
          showStatus('‚ùå ' + (data.error || 'Error al guardar config'), true);
        }
      } catch (err) {
        showStatus('‚ùå Error al guardar config', true);
      }
    }

    async function publishTicketPanel() {
      const channelId = document.getElementById('channelSelect').value;
      if (!channelId) return showStatus('Selecciona un canal', true);

      const title = document.getElementById('ticketPanelTitle').value;
      const description = document.getElementById('ticketPanelDescription').value;
      const buttonLabel = document.getElementById('ticketPanelButtonLabel').value;

      try {
        const res = await fetch(`${API_BASE}/api/tickets/panel`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ channelId, title, description, buttonLabel })
        });

        if (res.ok) {
          showStatus('‚úÖ Panel de tickets publicado');
        } else {
          const data = await res.json();
          showStatus('‚ùå ' + (data.error || 'Error al publicar panel'), true);
        }
      } catch (err) {
        showStatus('‚ùå Error al publicar panel', true);
      }
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('discord-blurple');
        el.classList.add('discord-dark');
      });
      document.getElementById(tab + 'Tab').classList.remove('hidden');
      document.querySelector(`[data-tab="${tab}"]`).classList.remove('discord-dark');
      document.querySelector(`[data-tab="${tab}"]`).classList.add('discord-blurple');
    }

    function showStatus(message, isError = false) {
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = `mt-4 p-3 rounded ${isError ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    async function sendSimpleMessage() {
      const channelId = document.getElementById('channelSelect').value;
      const content = document.getElementById('simpleMessage').value;
      if (!channelId || !content) return showStatus('Selecciona un canal y escribe un mensaje', true);
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);

      try {
        const res = await fetch(`${API_BASE}/api/send-message`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, channelId, content })
        });
        if (res.ok) {
          showStatus('‚úÖ Mensaje enviado correctamente');
          document.getElementById('simpleMessage').value = '';
        } else {
          const data = await res.json();
          showStatus('‚ùå ' + data.error, true);
        }
      } catch (err) {
        showStatus('‚ùå Error al enviar', true);
      }
    }

    function addField() {
      const container = document.getElementById('fieldsContainer');
      const div = document.createElement('div');
      div.className = 'flex gap-2';
      div.innerHTML = `
        <input type="text" placeholder="Nombre" class="flex-1 p-2 rounded discord-input text-white outline-none field-name">
        <input type="text" placeholder="Valor" class="flex-1 p-2 rounded discord-input text-white outline-none field-value">
        <button onclick="this.parentElement.remove()" class="text-red-400 px-2">‚úï</button>
      `;
      container.appendChild(div);
    }

    function addButton() {
      const container = document.getElementById('buttonsContainer');
      const div = document.createElement('div');
      div.className = 'flex gap-2';
      div.innerHTML = `
        <input type="text" placeholder="Texto" class="flex-1 p-2 rounded discord-input text-white outline-none btn-label">
        <input type="text" placeholder="Emoji (opcional)" class="w-24 p-2 rounded discord-input text-white outline-none btn-emoji">
        <select class="p-2 rounded discord-input text-white outline-none btn-style">
          <option value="Primary">Azul</option>
          <option value="Success">Verde</option>
          <option value="Danger">Rojo</option>
          <option value="Secondary">Gris</option>
        </select>
        <button onclick="this.parentElement.remove()" class="text-red-400 px-2">‚úï</button>
      `;
      container.appendChild(div);
    }

    async function sendEmbed() {
      const channelId = document.getElementById('channelSelect').value;
      if (!channelId) return showStatus('Selecciona un canal', true);
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);

      const embed = {
        title: document.getElementById('embedTitle').value,
        description: document.getElementById('embedDescription').value,
        color: document.getElementById('embedColor').value,
        image: document.getElementById('embedImage').value,
        thumbnail: document.getElementById('embedThumbnail').value,
        author: document.getElementById('embedAuthor').value,
        footer: document.getElementById('embedFooter').value,
        timestamp: document.getElementById('embedTimestamp').checked,
        fields: []
      };

      document.querySelectorAll('#fieldsContainer > div').forEach(div => {
        const name = div.querySelector('.field-name').value;
        const value = div.querySelector('.field-value').value;
        if (name && value) embed.fields.push({ name, value });
      });

      const buttons = [];
      document.querySelectorAll('#buttonsContainer > div').forEach(div => {
        const label = div.querySelector('.btn-label').value;
        const emoji = div.querySelector('.btn-emoji').value;
        const style = div.querySelector('.btn-style').value;
        if (label) buttons.push({ label, emoji, style });
      });

      try {
        const res = await fetch(`${API_BASE}/api/send-embed`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, channelId, embed, buttons })
        });
        if (res.ok) {
          showStatus('‚úÖ Embed enviado correctamente');
        } else {
          const data = await res.json();
          showStatus('‚ùå ' + data.error, true);
        }
      } catch (err) {
        showStatus('‚ùå Error al enviar', true);
      }
    }

    async function sendImage() {
      const channelId = document.getElementById('channelSelect').value;
      const imageUrl = document.getElementById('imageUrl').value;
      const caption = document.getElementById('imageCaption').value;
      if (!channelId || !imageUrl) return showStatus('Selecciona un canal y proporciona una URL', true);
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);

      try {
        const res = await fetch(`${API_BASE}/api/send-image`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, channelId, imageUrl, caption })
        });
        if (res.ok) {
          showStatus('‚úÖ Imagen enviada correctamente');
          document.getElementById('imageUrl').value = '';
          document.getElementById('imageCaption').value = '';
        } else {
          const data = await res.json();
          showStatus('‚ùå ' + data.error, true);
        }
      } catch (err) {
        showStatus('‚ùå Error al enviar', true);
      }
    }

    async function sendProduct() {
      const channelId = document.getElementById('channelSelect').value;
      if (!channelId) return showStatus('Selecciona un canal', true);

      const embed = {
        title: 'üéÆ ' + (document.getElementById('productName').value || 'PRODUCTO'),
        description: document.getElementById('productDescription').value + '\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
        color: document.getElementById('productColor').value,
        image: document.getElementById('productImage').value,
        footer: document.getElementById('productFooter').value || '‚úÖ TODO PRODUCTO SALE CON GARANT√çA Y SEGURIDAD',
        timestamp: true,
        fields: [
          { name: 'üí∞ PRECIOS:', value: `‚Ä¢ D√≠a: ${document.getElementById('productPriceDaily').value}\n‚Ä¢ Mensual: ${document.getElementById('productPriceMonthly').value}` },
          { name: 'üì© ADQUIRIR:', value: 'Para adquirir nuestro producto, abre un üé´ **TICKET**' }
        ]
      };

      const buttons = [
        { label: 'üé´ TICKET', style: 'Success', customId: 'ticket_create' },
        { label: 'üìã M√ÅS INFO', style: 'Primary', customId: 'producto_info' }
      ];

      try {
        const res = await fetch(`${API_BASE}/api/send-embed`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ channelId, embed, buttons })
        });
        if (res.ok) {
          showStatus('‚úÖ Producto enviado correctamente');
        } else {
          const data = await res.json();
          showStatus('‚ùå ' + data.error, true);
        }
      } catch (err) {
        showStatus('‚ùå Error al enviar', true);
      }
    }

    async function loadRaidSettings(guildIdOverride = null) {
      const guildId = guildIdOverride || selectedGuild;
      if (!guildId) return;

      try {
        const res = await fetch(`${API_BASE}/api/settings/raid?guildId=${encodeURIComponent(guildId)}`, {
          headers: { 'Authorization': token }
        });
        const data = res.ok ? await res.json() : {};

        document.getElementById('raidEnabled').checked = Boolean(data.enabled);
        document.getElementById('raidJoinWindowMs').value = String(data.joinWindowMs || 15000);
        document.getElementById('raidJoinThreshold').value = String(data.joinThreshold || 8);
        document.getElementById('raidDefenseDurationMs').value = String(data.defenseDurationMs || 300000);
        document.getElementById('raidSlowmodeSeconds').value = String(data.slowmodeSeconds || 10);
        document.getElementById('raidLogChannelSelect').value = data.logChannelId || '';

        showStatus('‚úÖ Anti-raid cargado');
      } catch (err) {
        showStatus('‚ùå No se pudo cargar anti-raid', true);
      }
    }

    async function saveRaidSettings() {
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);

      const settings = {
        enabled: document.getElementById('raidEnabled').checked,
        joinWindowMs: Number(document.getElementById('raidJoinWindowMs').value || 15000),
        joinThreshold: Number(document.getElementById('raidJoinThreshold').value || 8),
        defenseDurationMs: Number(document.getElementById('raidDefenseDurationMs').value || 300000),
        slowmodeSeconds: Number(document.getElementById('raidSlowmodeSeconds').value || 10),
        logChannelId: document.getElementById('raidLogChannelSelect').value || null,
      };

      try {
        const res = await fetch(`${API_BASE}/api/settings/raid`, {
          method: 'PUT',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, settings })
        });

        if (res.ok) {
          showStatus('‚úÖ Anti-raid guardado');
        } else {
          const data = await res.json().catch(() => ({}));
          showStatus('‚ùå ' + (data.error || 'Error al guardar anti-raid'), true);
        }
      } catch (err) {
        showStatus('‚ùå Error al guardar anti-raid', true);
      }
    }

    async function configureAll() {
      if (!selectedGuild) return showStatus('Selecciona un servidor primero', true);
      const publishChannelId = document.getElementById('channelSelect')?.value || null;

      try {
        showStatus('‚è≥ Configurando TODO... espera');
        const res = await fetch(`${API_BASE}/api/setup/configure-all`, {
          method: 'POST',
          headers: { 'Authorization': token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ guildId: selectedGuild, publishChannelId })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) return showStatus('‚ùå ' + (data.error || 'No se pudo configurar todo'), true);

        showStatus('‚úÖ Configurado TODO (Setup + presets + paneles)');

        await loadGuilds();
        if (selectedGuild) await selectGuild(selectedGuild, '');
        await setupPreview();
        await loadModerationSettings();
        await loadLogsSettings();
        await loadVerifySettings();
        await loadRaidSettings();
      } catch (err) {
        showStatus('‚ùå Error al configurar todo', true);
      }
    }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    try {
      const firebaseConfig = {
        apiKey: "AIzaSyCU64ObSH3UpT2AmcJ82HFfKyk4w_H9ynE",
        authDomain: "discord-bot-a4a41.firebaseapp.com",
        projectId: "discord-bot-a4a41",
        storageBucket: "discord-bot-a4a41.firebasestorage.app",
        messagingSenderId: "505761495708",
        appId: "1:505761495708:web:17ff192ad1c5733a828b59",
      };

      const app = initializeApp(firebaseConfig);
      window.firebaseApp = app;
      window.firebaseAuth = getAuth(app);
      window.firebaseDb = getFirestore(app);
    } catch (e) {
      console.error('Firebase init error:', e);
    }
  </script>
</body>
</html>
