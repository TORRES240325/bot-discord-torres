<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel de Administraci√≥n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .glass{background:rgba(17,24,39,.72);border:1px solid rgba(255,255,255,.10);backdrop-filter:blur(14px)}
    .in{background:rgba(3,7,18,.55);border:1px solid rgba(255,255,255,.12);border-radius:.75rem;padding:.55rem .75rem;width:100%;color:rgba(255,255,255,.92);outline:none}
    .in:focus{border-color:rgba(34,197,94,.55);box-shadow:0 0 0 3px rgba(34,197,94,.14)}
    .btn{border-radius:.75rem;padding:.55rem .85rem;font-weight:700;border:1px solid rgba(255,255,255,.12)}
    .btnP{background:linear-gradient(135deg,#22c55e,#16a34a);color:#04130a;border-color:rgba(34,197,94,.35)}
    .btnS{background:rgba(255,255,255,.06);color:rgba(255,255,255,.92)}
    .btnD{background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.25);color:rgba(255,255,255,.92)}
    .nav{display:flex;gap:.6rem;align-items:center;padding:.6rem .75rem;border-radius:.9rem;cursor:pointer;border:1px solid transparent;color:rgba(255,255,255,.75)}
    .nav:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.10);color:rgba(255,255,255,.92)}
    .nav.active{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.22);color:rgba(255,255,255,.95)}
    .sec{display:none}.sec.active{display:block}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white/90">
  <div id="toast" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <div id="login" class="min-h-screen flex items-center justify-center px-6">
    <div class="glass rounded-2xl p-7 w-full max-w-md">
      <div class="text-center">
        <div class="inline-flex items-center justify-center w-14 h-14 rounded-2xl bg-white/5 border border-white/10">
          <i class="fa-solid fa-shield-halved text-white/90"></i>
        </div>
        <h1 class="mt-5 text-3xl font-extrabold tracking-tight text-emerald-400">Panel de Administraci√≥n</h1>
        <p class="mt-1 text-white/60">Administra tu servidor desde un solo lugar</p>
      </div>
      <div class="mt-6 space-y-3">
        <label class="block text-sm text-white/60">Contrase√±a</label>
        <input id="pw" class="in" type="password" placeholder="Contrase√±a del dashboard" />
        <button id="btnLogin" class="btn btnP w-full" type="button">Entrar</button>
        <p id="err" class="hidden text-sm text-red-400">No autorizado</p>
        <div class="pt-2 text-xs text-white/60">API: <span id="apiLbl" class="font-mono"></span></div>
        <div class="grid grid-cols-1 gap-2">
          <input id="apiInput" class="in" placeholder="https://TU-PROYECTO.up.railway.app" />
          <button id="btnSetApi" class="btn btnS w-full" type="button">Guardar API</button>
        </div>
      </div>
    </div>
  </div>

  <div id="app" class="hidden">
    <header class="glass sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-5 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 rounded-2xl bg-white/5 border border-white/10 grid place-items-center overflow-hidden">
            <img id="botAvatar" class="w-10 h-10" alt="bot" />
          </div>
          <div>
            <div class="font-extrabold text-white/90">Panel de Administraci√≥n</div>
            <div id="botUser" class="text-sm text-white/60">Bot</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnRefresh" class="btn btnS" type="button"><i class="fa-solid fa-rotate mr-2"></i>Refrescar</button>
          <button id="btnLogout" class="btn btnS" type="button"><i class="fa-solid fa-right-from-bracket mr-2"></i>Salir</button>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-5 py-6 grid grid-cols-1 lg:grid-cols-[280px_1fr] gap-6">
      <aside class="glass rounded-2xl p-4 h-fit lg:sticky lg:top-24">
        <div class="space-y-3">
          <div>
            <label class="block text-xs uppercase tracking-wider text-white/60">Servidor</label>
            <select id="guild" class="in mt-2"></select>
          </div>
          <div class="grid gap-2">
            <div class="nav active" data-s="overview"><i class="fa-solid fa-grip"></i><span>Inicio</span></div>
            <div class="nav" data-s="tickets"><i class="fa-solid fa-ticket"></i><span>Tickets</span></div>
            <div class="nav" data-s="welcome"><i class="fa-solid fa-hand-sparkles"></i><span>Bienvenida</span></div>
            <div class="nav" data-s="verify"><i class="fa-solid fa-circle-check"></i><span>Verificaci√≥n</span></div>
            <div class="nav" data-s="messages"><i class="fa-solid fa-message"></i><span>Mensajes</span></div>
            <div class="nav" data-s="moderation"><i class="fa-solid fa-shield"></i><span>Moderaci√≥n</span></div>
            <div class="nav" data-s="raid"><i class="fa-solid fa-bolt"></i><span>Anti-Raid</span></div>
            <div class="nav" data-s="logs"><i class="fa-solid fa-clipboard-list"></i><span>Logs</span></div>
            <div class="nav" data-s="setup"><i class="fa-solid fa-wand-magic-sparkles"></i><span>Setup</span></div>
            <div class="nav" data-s="health"><i class="fa-solid fa-heart-pulse"></i><span>Salud</span></div>
            <div class="nav" data-s="history"><i class="fa-solid fa-clock-rotate-left"></i><span>Historial</span></div>
            <div class="nav" data-s="help"><i class="fa-solid fa-circle-question"></i><span>Ayuda</span></div>
          </div>
        </div>
      </aside>

      <main class="space-y-6">
        <section id="overview" class="sec active">
          <div class="glass rounded-2xl p-6">
            <h2 class="text-2xl font-extrabold text-white/90">Accesos r√°pidos</h2>
            <p class="mt-1 text-white/60">Secciones reales del bot: tickets, bienvenida, verificaci√≥n, mensajes, protecci√≥n, logs, etc.</p>
            <div class="mt-5 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
              <button class="glass rounded-2xl p-5 text-left" data-go="tickets" type="button"><div class="flex items-center justify-between"><div class="font-bold">Tickets</div><i class="fa-solid fa-arrow-right"></i></div><div class="text-sm mt-1 text-white/60">Soporte + compras (panel tienda)</div></button>
              <button class="glass rounded-2xl p-5 text-left" data-go="welcome" type="button"><div class="flex items-center justify-between"><div class="font-bold">Bienvenida</div><i class="fa-solid fa-arrow-right"></i></div><div class="text-sm mt-1 text-white/60">Mensaje + embed + botones</div></button>
              <button class="glass rounded-2xl p-5 text-left" data-go="messages" type="button"><div class="flex items-center justify-between"><div class="font-bold">Mensajes</div><i class="fa-solid fa-arrow-right"></i></div><div class="text-sm mt-1 text-white/60">Plantillas (CRUD) + publicar</div></button>
            </div>
          </div>
        </section>

        <section id="help" class="sec">
          <div class="glass rounded-2xl p-6 space-y-5">
            <div>
              <h2 class="text-2xl font-extrabold text-white/90">Ayuda r√°pida</h2>
              <p class="mt-1 text-white/60">Genera menciones y textos listos para pegar. Sin comandos.</p>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
              <div class="glass rounded-2xl p-4 space-y-3">
                <div class="font-bold">Menciones (click y copiar)</div>

                <label class="block text-sm text-white/60">Canal</label>
                <select id="help_channelSel" class="in"></select>
                <div class="flex gap-2">
                  <input id="help_channelMention" class="in" placeholder="<#canalId>" />
                  <button class="btn btnS" type="button" onclick="copyText('help_channelMention')">Copiar</button>
                </div>

                <label class="block text-sm text-white/60">Rol</label>
                <select id="help_roleSel" class="in"></select>
                <div class="flex gap-2">
                  <input id="help_roleMention" class="in" placeholder="<@&rolId>" />
                  <button class="btn btnS" type="button" onclick="copyText('help_roleMention')">Copiar</button>
                </div>

                <label class="block text-sm text-white/60">Usuario (pega el ID)</label>
                <div class="flex gap-2">
                  <input id="help_userId" class="in" placeholder="userId" />
                  <button class="btn btnS" type="button" onclick="makeUserMention()">Generar</button>
                </div>
                <div class="flex gap-2">
                  <input id="help_userMention" class="in" placeholder="<@userId>" />
                  <button class="btn btnS" type="button" onclick="copyText('help_userMention')">Copiar</button>
                </div>
              </div>

              <div class="glass rounded-2xl p-4 space-y-3">
                <div class="font-bold">Plantillas listas (solo copiar)</div>
                <textarea id="help_templates" class="in" rows="12" placeholder=""></textarea>
                <div class="flex gap-2">
                  <button class="btn btnS" type="button" onclick="copyText('help_templates')">Copiar todo</button>
                  <button class="btn btnP" type="button" onclick="fillHelpTemplates()">Recargar ejemplos</button>
                </div>
                <div class="text-xs text-white/60">Incluye placeholders: <span class="font-mono">{mention}</span> <span class="font-mono">{guildName}</span> <span class="font-mono">{memberCount}</span> y formatos de menci√≥n.</div>
              </div>
            </div>
          </div>
        </section>

        <section id="tickets" class="sec">
          <div class="glass rounded-2xl p-6 space-y-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-2xl font-extrabold text-white/90">Tickets</h2>
                <p class="mt-1 text-white/60">Configura tickets y publica panel de soporte / panel de compras (tienda).</p>
              </div>
              <div class="flex gap-2">
                <button class="btn btnS" type="button" onclick="loadSettings('tickets')">Cargar</button>
                <button class="btn btnP" type="button" onclick="saveSettings('tickets')">Guardar</button>
              </div>
            </div>

            <div class="glass rounded-2xl p-4 space-y-3">
              <div class="font-bold">Configuraci√≥n r√°pida (sin copiar IDs)</div>
              <div class="grid grid-cols-1 xl:grid-cols-3 gap-3">
                <div>
                  <label class="block text-sm text-white/60">Categor√≠a tickets</label>
                  <select id="ticket_categorySel" class="in mt-2"></select>
                </div>
                <div>
                  <label class="block text-sm text-white/60">Rol staff/soporte</label>
                  <select id="ticket_staffRoleSel" class="in mt-2"></select>
                </div>
                <div>
                  <label class="block text-sm text-white/60">Canal logs (opcional)</label>
                  <select id="ticket_logChannelSel" class="in mt-2"></select>
                </div>
              </div>
              <div class="flex gap-2">
                <button class="btn btnP" type="button" onclick="applyTicketQuickConfig()">Aplicar configuraci√≥n</button>
                <button class="btn btnS" type="button" onclick="copyTicketMentions()">Copiar menciones</button>
              </div>
              <div class="text-xs text-white/60">Tip: "Copiar menciones" te deja en portapapeles los formatos <span class="font-mono">&lt;#canal&gt;</span> y <span class="font-mono">&lt;@&amp;rol&gt;</span> para usarlos en embeds.</div>
            </div>

            <div>
              <label class="block text-sm text-white/60">Configuraci√≥n (Firestore): `guilds/{guildId}/settings/tickets`</label>
              <textarea id="settings_tickets" class="in mt-2" rows="10" placeholder=""></textarea>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
              <div class="glass rounded-2xl p-4 space-y-3">
                <div class="font-bold">Publicar panel de soporte</div>
                <select id="support_channelSel" class="in"></select>
                <input id="support_channelId" class="in" placeholder="channelId (opcional, override)" />
                <input id="support_title" class="in" placeholder="title (opcional)" />
                <textarea id="support_description" class="in" rows="3" placeholder="description (opcional)"></textarea>
                <input id="support_buttonLabel" class="in" placeholder="buttonLabel (opcional)" />
                <button class="btn btnP" type="button" onclick="publishSupportPanel()">Publicar soporte</button>
              </div>

              <div class="glass rounded-2xl p-4 space-y-3">
                <div class="font-bold">Publicar panel compras (tienda)</div>
                <select id="purchase_channelSel" class="in"></select>
                <input id="purchase_channelId" class="in" placeholder="channelId (opcional, override)" />
                <input id="purchase_placeholder" class="in" placeholder="Texto del men√∫ (ej: ¬°ADQUIERE EL PRODUCTO ‚ú®)" />

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm text-white/60">T√≠tulo</label>
                    <input id="purchase_title" class="in mt-2" placeholder="TCC" />
                  </div>
                  <div>
                    <label class="block text-sm text-white/60">Color</label>
                    <input id="purchase_color" class="in mt-2" placeholder="#ff2d2d" />
                  </div>
                </div>
                <div>
                  <label class="block text-sm text-white/60">Descripci√≥n</label>
                  <textarea id="purchase_description" class="in mt-2" rows="4" placeholder="Texto del panel (puedes poner emojis)"></textarea>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm text-white/60">Imagen (URL)</label>
                    <input id="purchase_image" class="in mt-2" placeholder="https://..." />
                  </div>
                  <div>
                    <label class="block text-sm text-white/60">Footer</label>
                    <input id="purchase_footer" class="in mt-2" placeholder="Powered by ..." />
                  </div>
                </div>

                <div class="glass rounded-2xl p-3 space-y-2">
                  <div class="flex items-center justify-between">
                    <div class="font-bold">Productos (opciones del men√∫)</div>
                    <button class="btn btnS" type="button" onclick="addPurchasePlan()">Agregar</button>
                  </div>
                  <div id="purchase_plansList" class="space-y-2"></div>
                </div>

                <button class="btn btnP" type="button" onclick="publishPurchasePanel()">Publicar compras</button>
              </div>
            </div>
          </div>
        </section>
        <section id="welcome" class="sec">
          <div class="glass rounded-2xl p-6 space-y-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-2xl font-extrabold text-white/90">Bienvenida</h2>
                <p class="mt-1 text-white/60">Edita settings y publica un preview en un canal.</p>
              </div>
              <div class="flex gap-2">
                <button class="btn btnS" type="button" onclick="loadWelcomeEasy()">Cargar</button>
                <button class="btn btnP" type="button" onclick="saveWelcomeEasy()">Guardar</button>
              </div>
            </div>
            <div class="glass rounded-2xl p-4 space-y-3">
              <div class="font-bold">Configuraci√≥n f√°cil</div>
              <div class="grid grid-cols-1 xl:grid-cols-2 gap-3">
                <label class="flex items-center gap-2">
                  <input id="welcome_enabled" type="checkbox" />
                  <span>Activar bienvenida</span>
                </label>
                <label class="flex items-center gap-2">
                  <input id="welcome_ping" type="checkbox" />
                  <span>Mencionar al usuario</span>
                </label>
              </div>

              <div>
                <label class="block text-sm text-white/60">Canal de bienvenida</label>
                <select id="welcome_cfgChannelSel" class="in mt-2"></select>
              </div>

              <div>
                <label class="block text-sm text-white/60">Texto (puedes usar emojis)</label>
                <textarea id="welcome_content" class="in mt-2" rows="3" placeholder="‚úÖ Bienvenido {mention} a {guildName}"></textarea>
              </div>

              <div class="grid grid-cols-1 xl:grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm text-white/60">T√≠tulo del embed</label>
                  <input id="welcome_embedTitle" class="in mt-2" placeholder="TCC" />
                </div>
                <div>
                  <label class="block text-sm text-white/60">Color</label>
                  <input id="welcome_embedColor" class="in mt-2" placeholder="#ff2d2d" />
                </div>
              </div>
              <div>
                <label class="block text-sm text-white/60">Descripci√≥n del embed</label>
                <textarea id="welcome_embedDesc" class="in mt-2" rows="3" placeholder="üìå Lee las reglas y abre ticket si necesitas ayuda"></textarea>
              </div>
              <div class="grid grid-cols-1 xl:grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm text-white/60">Imagen (URL opcional)</label>
                  <input id="welcome_embedImage" class="in mt-2" placeholder="https://..." />
                </div>
                <div>
                  <label class="block text-sm text-white/60">Footer (opcional)</label>
                  <input id="welcome_embedFooter" class="in mt-2" placeholder="Powered by TCC" />
                </div>
              </div>
              <div>
                <label class="block text-sm text-white/60">Borrar despu√©s de (segundos, opcional)</label>
                <input id="welcome_deleteAfter" class="in mt-2" placeholder="0" />
              </div>

              <div class="text-xs text-white/60">Puedes usar: <span class="font-mono">{mention}</span> <span class="font-mono">{guildName}</span> <span class="font-mono">{memberCount}</span></div>
            </div>

            <details class="glass rounded-2xl p-4">
              <summary class="font-bold cursor-pointer">Avanzado (oculto)</summary>
              <textarea id="settings_welcome" class="in mt-3" rows="10" placeholder=""></textarea>
            </details>
            <div class="glass rounded-2xl p-4 space-y-3">
              <div class="font-bold">Publicar preview</div>
              <select id="welcome_channelSel" class="in"></select>
              <input id="welcome_channelId" class="in" placeholder="channelId (opcional, override)" />
              <button class="btn btnP" type="button" onclick="publishWelcomePreview()">Publicar preview</button>
            </div>
          </div>
        </section>

        <section id="verify" class="sec">
          <div class="glass rounded-2xl p-6 space-y-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-2xl font-extrabold text-white/90">Verificaci√≥n</h2>
                <p class="mt-1 text-white/60">Edita settings y publica el panel de verificaci√≥n.</p>
              </div>
              <div class="flex gap-2">
                <button class="btn btnS" type="button" onclick="loadVerifyEasy()">Cargar</button>
                <button class="btn btnP" type="button" onclick="saveVerifyEasy()">Guardar</button>
              </div>
            </div>
            <div class="glass rounded-2xl p-4 space-y-3">
              <div class="font-bold">Configuraci√≥n f√°cil</div>
              <label class="flex items-center gap-2">
                <input id="verify_enabled" type="checkbox" />
                <span>Activar verificaci√≥n</span>
              </label>

              <div class="grid grid-cols-1 xl:grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm text-white/60">Rol a dar al verificar</label>
                  <select id="verify_roleSel" class="in mt-2"></select>
                </div>
                <div>
                  <label class="block text-sm text-white/60">Rol autom√°tico al entrar (opcional)</label>
                  <select id="verify_autoRoleSel" class="in mt-2"></select>
                </div>
              </div>

              <div class="grid grid-cols-1 xl:grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm text-white/60">T√≠tulo del panel</label>
                  <input id="verify_panelTitle" class="in mt-2" placeholder="‚úÖ Verificaci√≥n" />
                </div>
                <div>
                  <label class="block text-sm text-white/60">Color</label>
                  <input id="verify_panelColor" class="in mt-2" placeholder="#ff2d2d" />
                </div>
              </div>
              <div>
                <label class="block text-sm text-white/60">Descripci√≥n</label>
                <textarea id="verify_panelDesc" class="in mt-2" rows="3" placeholder="Presiona el bot√≥n para verificarte."></textarea>
              </div>
              <div>
                <label class="block text-sm text-white/60">Texto del bot√≥n</label>
                <input id="verify_buttonLabel" class="in mt-2" placeholder="Verificarme" />
              </div>
            </div>

            <details class="glass rounded-2xl p-4">
              <summary class="font-bold cursor-pointer">Avanzado (oculto)</summary>
              <textarea id="settings_verify" class="in mt-3" rows="10" placeholder=""></textarea>
            </details>
            <div class="glass rounded-2xl p-4 space-y-3">
              <div class="font-bold">Publicar panel</div>
              <select id="verify_channelSel" class="in"></select>
              <input id="verify_channelId" class="in" placeholder="channelId (opcional, override)" />
              <button class="btn btnP" type="button" onclick="publishVerifyPanel()">Publicar panel</button>
            </div>
          </div>
        </section>
        <section id="messages" class="sec">
          <div class="glass rounded-2xl p-6 space-y-5">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-2xl font-extrabold text-white/90">Mensajes</h2>
                <p class="mt-1 text-white/60">Enviar mensajes a un canal con botones y desplegables.</p>
              </div>
              <div class="flex gap-2">
                <button class="btn btnS" type="button" onclick="fillMessageEasyExamples()">Ejemplos</button>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
              <div class="glass rounded-2xl p-4 space-y-3">
                <div class="font-bold">Enviar mensaje</div>
                <label class="block text-sm text-white/60">Canal</label>
                <select id="msg_channelSel" class="in mt-2"></select>
                <label class="block text-sm text-white/60">Texto</label>
                <textarea id="msg_content" class="in mt-2" rows="5" placeholder="Escribe tu mensaje (emojis permitidos)"></textarea>
                <button class="btn btnP" type="button" onclick="sendMessageEasy()">Enviar</button>
              </div>

              <div class="glass rounded-2xl p-4 space-y-3">
                <div class="font-bold">Enviar embed (bonito)</div>
                <label class="block text-sm text-white/60">Canal</label>
                <select id="embed_channelSel" class="in mt-2"></select>
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm text-white/60">T√≠tulo</label>
                    <input id="embed_title" class="in mt-2" placeholder="TCC" />
                  </div>
                  <div>
                    <label class="block text-sm text-white/60">Color</label>
                    <input id="embed_color" class="in mt-2" placeholder="#ff2d2d" />
                  </div>
                </div>
                <div>
                  <label class="block text-sm text-white/60">Descripci√≥n</label>
                  <textarea id="embed_description" class="in mt-2" rows="4" placeholder="Texto del embed (puedes usar emojis)"></textarea>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm text-white/60">Imagen (URL opcional)</label>
                    <input id="embed_image" class="in mt-2" placeholder="https://..." />
                  </div>
                  <div>
                    <label class="block text-sm text-white/60">Footer (opcional)</label>
                    <input id="embed_footer" class="in mt-2" placeholder="Powered by TCC" />
                  </div>
                </div>
                <button class="btn btnP" type="button" onclick="sendEmbedEasy()">Enviar embed</button>
              </div>
            </div>

            <div class="glass rounded-2xl p-4 space-y-3">
              <div class="font-bold">Enviar imagen</div>
              <label class="block text-sm text-white/60">Canal</label>
              <select id="img_channelSel" class="in mt-2"></select>
              <label class="block text-sm text-white/60">URL de la imagen</label>
              <input id="img_url" class="in mt-2" placeholder="https://..." />
              <label class="block text-sm text-white/60">Texto (opcional)</label>
              <input id="img_caption" class="in mt-2" placeholder="Texto corto" />
              <button class="btn btnP" type="button" onclick="sendImageEasy()">Enviar imagen</button>
            </div>

            <details class="glass rounded-2xl p-4">
              <summary class="font-bold cursor-pointer">Avanzado (oculto)</summary>
              <div class="mt-3 space-y-5">

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
              <div class="glass rounded-2xl p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <div class="font-bold">Plantillas guardadas</div>
                  <div class="text-sm text-white/60">Click para cargar en el editor</div>
                </div>
                <div id="tplList" class="space-y-2"></div>
              </div>

              <div class="glass rounded-2xl p-4 space-y-3">
                <div class="font-bold">Crear / Editar plantilla</div>
                <input id="tplId" class="in" placeholder="templateId (vac√≠o para crear)" />
                <input id="tplName" class="in" placeholder="Nombre" />
                <select id="tplType" class="in">
                  <option value="simple">simple</option>
                  <option value="embed">embed</option>
                  <option value="image">image</option>
                  <option value="product">product</option>
                </select>
                <div class="grid grid-cols-2 gap-2">
                  <button class="btn btnS" type="button" onclick="fillTemplateExample('simple')">Ejemplo simple</button>
                  <button class="btn btnS" type="button" onclick="fillTemplateExample('embed')">Ejemplo embed</button>
                  <button class="btn btnS" type="button" onclick="fillTemplateExample('image')">Ejemplo imagen</button>
                  <button class="btn btnS" type="button" onclick="fillTemplateExample('product')">Ejemplo producto</button>
                </div>
                <textarea id="tplData" class="in" rows="7" placeholder='data JSON. Ej: {"content":"hola"} o {"embed":{...},"buttons":[]}'></textarea>
                <div class="flex gap-2">
                  <button class="btn btnP" type="button" onclick="saveTemplate()">Guardar</button>
                  <button class="btn btnD" type="button" onclick="deleteTemplate()">Eliminar</button>
                  <button class="btn btnS" type="button" onclick="clearTemplateForm()">Limpiar</button>
                </div>

                <div class="h-px bg-white/10"></div>

                <div class="font-bold">Publicar plantilla en un canal</div>
                <select id="tplPublishChannelSel" class="in"></select>
                <input id="tplPublishChannel" class="in" placeholder="channelId (opcional, override)" />
                <button class="btn btnP" type="button" onclick="publishTemplate()">Publicar</button>
              </div>
            </div>

            <div class="glass rounded-2xl p-4 space-y-3">
              <div class="font-bold">Editar un mensaje ya enviado (no borra)</div>
              <div class="grid grid-cols-1 xl:grid-cols-3 gap-3">
                <select id="editMsgChannelSel" class="in"></select>
                <input id="editMsgId" class="in" placeholder="messageId" />
                <button class="btn btnP" type="button" onclick="editMessage()">Editar mensaje</button>
              </div>
              <input id="editMsgChannel" class="in" placeholder="channelId (opcional, override)" />
              <textarea id="editMsgPayload" class="in" rows="6" placeholder='JSON: {"content":"nuevo texto","embed":{...},"buttons":[]}'></textarea>
            </div>
              </div>
            </details>
          </div>
        </section>
        <section id="moderation" class="sec">
          <div class="glass rounded-2xl p-6 space-y-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-2xl font-extrabold text-white/90">Moderaci√≥n (Protecci√≥n)</h2>
                <p class="mt-1 text-white/60">Anti-links, anti-invites, anti-spam. (protection.js)</p>
              </div>
              <div class="flex gap-2">
                <button class="btn btnS" type="button" onclick="loadModerationEasy()">Cargar</button>
                <button class="btn btnP" type="button" onclick="saveModerationEasy()">Guardar</button>
              </div>
            </div>
            <div class="glass rounded-2xl p-4 space-y-3">
              <div class="font-bold">Configuraci√≥n f√°cil</div>
              <label class="flex items-center gap-2"><input id="mod_enabled" type="checkbox" /><span>Activar moderaci√≥n</span></label>
              <div class="grid grid-cols-1 xl:grid-cols-3 gap-3">
                <label class="flex items-center gap-2"><input id="mod_links" type="checkbox" /><span>Bloquear links</span></label>
                <label class="flex items-center gap-2"><input id="mod_invites" type="checkbox" /><span>Bloquear invites</span></label>
                <label class="flex items-center gap-2"><input id="mod_spam" type="checkbox" /><span>Anti-spam</span></label>
              </div>

              <div class="grid grid-cols-1 xl:grid-cols-3 gap-3">
                <div>
                  <label class="block text-sm text-white/60">Ventana spam (ms)</label>
                  <input id="mod_spamWindow" class="in mt-2" placeholder="7000" />
                </div>
                <div>
                  <label class="block text-sm text-white/60">M√°x mensajes</label>
                  <input id="mod_spamMax" class="in mt-2" placeholder="6" />
                </div>
                <div>
                  <label class="block text-sm text-white/60">Timeout spam (ms)</label>
                  <input id="mod_spamTimeout" class="in mt-2" placeholder="60000" />
                </div>
              </div>

              <div>
                <label class="block text-sm text-white/60">Canal de logs (opcional)</label>
                <select id="mod_logChannelSel" class="in mt-2"></select>
              </div>

              <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                <div class="glass rounded-2xl p-3 space-y-2">
                  <div class="flex items-center justify-between">
                    <div class="font-bold">Roles exentos</div>
                    <button class="btn btnS" type="button" onclick="addModExemptRole()">Agregar</button>
                  </div>
                  <select id="mod_rolePick" class="in"></select>
                  <div id="mod_rolesList" class="space-y-2"></div>
                </div>
                <div class="glass rounded-2xl p-3 space-y-2">
                  <div class="flex items-center justify-between">
                    <div class="font-bold">Canales exentos</div>
                    <button class="btn btnS" type="button" onclick="addModExemptChannel()">Agregar</button>
                  </div>
                  <select id="mod_channelPick" class="in"></select>
                  <div id="mod_channelsList" class="space-y-2"></div>
                </div>
              </div>

              <div>
                <label class="block text-sm text-white/60">Links permitidos (uno por l√≠nea, opcional)</label>
                <textarea id="mod_whitelist" class="in mt-2" rows="4" placeholder="example.com"></textarea>
              </div>
            </div>

            <details class="glass rounded-2xl p-4">
              <summary class="font-bold cursor-pointer">Avanzado (oculto)</summary>
              <textarea id="settings_moderation" class="in mt-3" rows="10" placeholder=""></textarea>
            </details>
          </div>
        </section>

        <section id="raid" class="sec">
          <div class="glass rounded-2xl p-6 space-y-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-2xl font-extrabold text-white/90">Anti-Raid</h2>
                <p class="mt-1 text-white/60">Defensa autom√°tica por joins masivos. (raid.js)</p>
              </div>
              <div class="flex gap-2">
                <button class="btn btnS" type="button" onclick="loadRaidEasy()">Cargar</button>
                <button class="btn btnP" type="button" onclick="saveRaidEasy()">Guardar</button>
              </div>
            </div>
            <div class="glass rounded-2xl p-4 space-y-3">
              <div class="font-bold">Configuraci√≥n f√°cil</div>
              <label class="flex items-center gap-2"><input id="raid_enabled" type="checkbox" /><span>Activar anti-raid</span></label>
              <div class="grid grid-cols-1 xl:grid-cols-4 gap-3">
                <div>
                  <label class="block text-sm text-white/60">Ventana joins (ms)</label>
                  <input id="raid_joinWindow" class="in mt-2" placeholder="15000" />
                </div>
                <div>
                  <label class="block text-sm text-white/60">Umbral joins</label>
                  <input id="raid_joinThreshold" class="in mt-2" placeholder="8" />
                </div>
                <div>
                  <label class="block text-sm text-white/60">Duraci√≥n defensa (ms)</label>
                  <input id="raid_duration" class="in mt-2" placeholder="300000" />
                </div>
                <div>
                  <label class="block text-sm text-white/60">Slowmode (seg)</label>
                  <input id="raid_slowmode" class="in mt-2" placeholder="10" />
                </div>
              </div>
              <label class="flex items-center gap-2"><input id="raid_lockLinks" type="checkbox" /><span>Bloquear links durante defensa</span></label>
              <div>
                <label class="block text-sm text-white/60">Canal logs (opcional)</label>
                <select id="raid_logChannelSel" class="in mt-2"></select>
              </div>
            </div>
            <details class="glass rounded-2xl p-4">
              <summary class="font-bold cursor-pointer">Avanzado (oculto)</summary>
              <textarea id="settings_raid" class="in mt-3" rows="10" placeholder=""></textarea>
            </details>
          </div>
        </section>

        <section id="logs" class="sec">
          <div class="glass rounded-2xl p-6 space-y-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-2xl font-extrabold text-white/90">Logs</h2>
                <p class="mt-1 text-white/60">Logs de joins/leaves/edits/deletes. (logs.js)</p>
              </div>
              <div class="flex gap-2">
                <button class="btn btnS" type="button" onclick="loadLogsEasy()">Cargar</button>
                <button class="btn btnP" type="button" onclick="saveLogsEasy()">Guardar</button>
              </div>
            </div>
            <div class="glass rounded-2xl p-4 space-y-3">
              <div class="font-bold">Configuraci√≥n f√°cil</div>
              <label class="flex items-center gap-2"><input id="logs_enabled" type="checkbox" /><span>Activar logs</span></label>
              <div>
                <label class="block text-sm text-white/60">Canal de logs</label>
                <select id="logs_channelSel" class="in mt-2"></select>
              </div>
              <div class="grid grid-cols-1 xl:grid-cols-4 gap-3">
                <label class="flex items-center gap-2"><input id="logs_joins" type="checkbox" /><span>Joins</span></label>
                <label class="flex items-center gap-2"><input id="logs_leaves" type="checkbox" /><span>Leaves</span></label>
                <label class="flex items-center gap-2"><input id="logs_delete" type="checkbox" /><span>Borrados</span></label>
                <label class="flex items-center gap-2"><input id="logs_edit" type="checkbox" /><span>Editados</span></label>
              </div>
            </div>
            <details class="glass rounded-2xl p-4">
              <summary class="font-bold cursor-pointer">Avanzado (oculto)</summary>
              <textarea id="settings_logs" class="in mt-3" rows="10" placeholder=""></textarea>
            </details>
          </div>
        </section>

        <section id="setup" class="sec">
          <div class="glass rounded-2xl p-6 space-y-4">
            <div>
              <h2 class="text-2xl font-extrabold text-white/90">Setup</h2>
              <p class="mt-1 text-white/60">Planifica/crea estructura base (roles/canales) y publica defaults.</p>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
              <div class="glass rounded-2xl p-4 space-y-3">
                <div class="font-bold">Plan</div>
                <button class="btn btnS" type="button" onclick="setupPlan()">Ver plan</button>
                <textarea id="setup_plan_out" class="in" rows="10" placeholder="Salida del plan..."></textarea>
              </div>
              <div class="glass rounded-2xl p-4 space-y-3">
                <div class="font-bold">Aplicar</div>
                <button class="btn btnP" type="button" onclick="setupApply()">Apply (crear roles/canales)</button>
                <div class="h-px bg-white/10"></div>
                <div class="font-bold">Configure-all (setup + publicaciones)</div>
                <input id="setup_publish_channel" class="in" placeholder="publishChannelId (opcional)" />
                <button class="btn btnP" type="button" onclick="setupConfigureAll()">Ejecutar configure-all</button>
              </div>
            </div>
          </div>
        </section>

        <section id="health" class="sec">
          <div class="glass rounded-2xl p-6 space-y-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-2xl font-extrabold text-white/90">Salud</h2>
                <p class="mt-1 text-white/60">Estado del backend y si hay settings guardados por m√≥dulo.</p>
              </div>
              <div class="flex gap-2">
                <button class="btn btnS" type="button" onclick="loadHealth()">Recargar</button>
              </div>
            </div>
            <textarea id="health_out" class="in" rows="12" placeholder="Salida de /api/health y /api/healthcheck/guild ..."></textarea>
          </div>
        </section>

        <section id="history" class="sec">
          <div class="glass rounded-2xl p-6 space-y-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-2xl font-extrabold text-white/90">Historial</h2>
                <p class="mt-1 text-white/60">Acciones realizadas desde el dashboard (publish/edit/etc.).</p>
              </div>
              <div class="flex gap-2">
                <button class="btn btnS" type="button" onclick="loadHistory()">Recargar</button>
              </div>
            </div>
            <textarea id="history_out" class="in" rows="14" placeholder="Salida de /api/history ..."></textarea>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const qs = new URLSearchParams(window.location.search);
    const apiFromQuery = qs.get('api');
    if (apiFromQuery) localStorage.setItem('dashboardApiBase', apiFromQuery);

    function normalizeApiBase(v) {
      const s = String(v || '').trim().replace(/\/+$/, '');
      return s;
    }

    function defaultApiBase() {
      const host = String(window.location.hostname || '').toLowerCase();
      if (host.includes('up.railway.app')) return normalizeApiBase(window.location.origin);
      if (host === 'localhost' || host === '127.0.0.1') return 'http://localhost:3000';
      if (host.endsWith('web.app') || host.endsWith('firebaseapp.com')) return 'https://bot-discord-torres-production.up.railway.app';
      return '';
    }

    let API_BASE = normalizeApiBase(localStorage.getItem('dashboardApiBase')) || defaultApiBase();
    document.getElementById('apiLbl').textContent = API_BASE || '(configura tu API)';
    const apiInputEl = document.getElementById('apiInput');
    if (apiInputEl) apiInputEl.value = API_BASE;

    let token = localStorage.getItem('dashboardToken') || null;
    let guildId = localStorage.getItem('dashboardGuildId') || null;

    function toast(msg, type = 'ok', details = null) {
      const el = document.createElement('div');
      el.className = 'glass rounded-xl px-4 py-3 text-sm';
      el.style.borderColor = type === 'err' ? 'rgba(239,68,68,.35)' : 'rgba(34,197,94,.30)';
      const host = document.createElement('div');
      const main = document.createElement('div');
      main.textContent = msg;
      host.appendChild(main);
      if (details) {
        const pre = document.createElement('pre');
        pre.className = 'mt-2 text-xs text-white/70 whitespace-pre-wrap break-words';
        pre.textContent = String(details);
        host.appendChild(pre);
      }
      el.appendChild(host);
      document.getElementById('toast').appendChild(el);
      setTimeout(() => el.remove(), type === 'err' ? 9000 : 3200);
    }

    async function api(path, options = {}) {
      if (!API_BASE) throw new Error('API no configurada. Pega tu URL de Railway en "API" y presiona Guardar API.');
      const headers = { ...(options.headers || {}) };
      if (token) headers.Authorization = token;
      if (!headers['Content-Type'] && options.body) headers['Content-Type'] = 'application/json';
      const res = await fetch(API_BASE + path, { ...options, headers });
      const txt = await res.text();
      let data = null;
      try { data = txt ? JSON.parse(txt) : null; } catch { data = txt; }
      if (!res.ok) throw new Error((data && data.error) ? data.error : ('HTTP ' + res.status));
      return data;
    }

    function setView(isLogged) {
      document.getElementById('login').classList.toggle('hidden', isLogged);
      document.getElementById('app').classList.toggle('hidden', !isLogged);
    }

    function showSection(id) {
      document.querySelectorAll('.sec').forEach((s) => s.classList.remove('active'));
      const target = document.getElementById(id);
      if (target) target.classList.add('active');
      document.querySelectorAll('.nav').forEach((n) => n.classList.remove('active'));
      const nav = document.querySelector(`.nav[data-s="${id}"]`);
      if (nav) nav.classList.add('active');
    }

    async function loadBotInfo() {
      const info = await api('/api/bot-info');
      if (info?.avatar) document.getElementById('botAvatar').src = info.avatar;
      document.getElementById('botUser').textContent = info?.username ? info.username : 'Bot';
    }

    async function loadGuilds() {
      const guilds = await api('/api/guilds');
      const select = document.getElementById('guild');
      select.innerHTML = '';
      for (const g of guilds || []) {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.textContent = g.name;
        select.appendChild(opt);
      }
      if (guilds?.length) {
        if (guildId && guilds.some((g) => String(g.id) === String(guildId))) {
          select.value = guildId;
        } else {
          guildId = String(guilds[0].id);
          select.value = guildId;
        }
        localStorage.setItem('dashboardGuildId', guildId);
      }
    }

    function fillSelectWithRoles(selectEl, roles) {
      if (!selectEl) return;
      selectEl.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = (roles && roles.length) ? 'Selecciona un rol‚Ä¶' : 'No hay roles disponibles';
      selectEl.appendChild(opt0);
      for (const r of roles || []) {
        const opt = document.createElement('option');
        opt.value = String(r.id);
        opt.textContent = String(r.name || r.id);
        selectEl.appendChild(opt);
      }
    }

    function fillSelectWithCategories(selectEl, categories) {
      if (!selectEl) return;
      selectEl.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = (categories && categories.length) ? 'Selecciona una categor√≠a‚Ä¶' : 'No hay categor√≠as disponibles';
      selectEl.appendChild(opt0);
      for (const c of categories || []) {
        const opt = document.createElement('option');
        opt.value = String(c.id);
        opt.textContent = String(c.name || c.id);
        selectEl.appendChild(opt);
      }
    }

    let _channelsCache = [];
    let _rolesCache = [];
    let _categoriesCache = [];
    let _purchasePlans = [];
    let _modExemptRoleIds = [];
    let _modExemptChannelIds = [];

    async function loadChannelsForGuild() {
      if (!guildId) return [];
      const channels = await api(`/api/guilds/${encodeURIComponent(guildId)}/channels`);
      return Array.isArray(channels) ? channels : [];
    }

    async function loadRolesForGuild() {
      if (!guildId) return [];
      const roles = await api(`/api/guilds/${encodeURIComponent(guildId)}/roles`);
      return Array.isArray(roles) ? roles : [];
    }

    async function loadCategoriesForGuild() {
      if (!guildId) return [];
      const categories = await api(`/api/guilds/${encodeURIComponent(guildId)}/categories`);
      return Array.isArray(categories) ? categories : [];
    }

    function buildChannelLabel(c) {
      const name = c?.name ? String(c.name) : '(sin nombre)';
      const t = c?.typeName ? String(c.typeName) : '';
      return t ? `${name}  [${t}]` : name;
    }

    function fillSelectWithChannels(selectEl, channels, { onlySendable = true } = {}) {
      if (!selectEl) return;
      selectEl.innerHTML = '';
      const usable = (channels || []).filter((c) => {
        if (!onlySendable) return true;
        return Boolean(c.canSend);
      });
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = usable.length ? 'Selecciona un canal‚Ä¶' : 'No hay canales disponibles';
      selectEl.appendChild(opt0);
      for (const c of usable) {
        const opt = document.createElement('option');
        opt.value = String(c.id);
        opt.textContent = buildChannelLabel(c);
        selectEl.appendChild(opt);
      }
    }

    function bindSelectToInput(selectId, inputId) {
      const sel = document.getElementById(selectId);
      const inp = document.getElementById(inputId);
      if (!sel || !inp) return;
      sel.addEventListener('change', () => {
        if (sel.value) inp.value = sel.value;
      });
    }

    async function refreshPickers() {
      _channelsCache = await loadChannelsForGuild();
      _rolesCache = await loadRolesForGuild();
      _categoriesCache = await loadCategoriesForGuild();

      fillSelectWithChannels(document.getElementById('support_channelSel'), _channelsCache);
      fillSelectWithChannels(document.getElementById('purchase_channelSel'), _channelsCache);
      fillSelectWithChannels(document.getElementById('welcome_channelSel'), _channelsCache);
      fillSelectWithChannels(document.getElementById('verify_channelSel'), _channelsCache);
      fillSelectWithChannels(document.getElementById('tplPublishChannelSel'), _channelsCache);
      fillSelectWithChannels(document.getElementById('editMsgChannelSel'), _channelsCache);

      fillSelectWithChannels(document.getElementById('help_channelSel'), _channelsCache, { onlySendable: false });
      fillSelectWithRoles(document.getElementById('help_roleSel'), _rolesCache);

      fillSelectWithCategories(document.getElementById('ticket_categorySel'), _categoriesCache);
      fillSelectWithRoles(document.getElementById('ticket_staffRoleSel'), _rolesCache);
      fillSelectWithChannels(document.getElementById('ticket_logChannelSel'), _channelsCache);

      fillSelectWithChannels(document.getElementById('welcome_cfgChannelSel'), _channelsCache);
      fillSelectWithRoles(document.getElementById('verify_roleSel'), _rolesCache);
      fillSelectWithRoles(document.getElementById('verify_autoRoleSel'), _rolesCache);

      fillSelectWithChannels(document.getElementById('msg_channelSel'), _channelsCache);
      fillSelectWithChannels(document.getElementById('embed_channelSel'), _channelsCache);
      fillSelectWithChannels(document.getElementById('img_channelSel'), _channelsCache);

      fillSelectWithChannels(document.getElementById('mod_logChannelSel'), _channelsCache);
      fillSelectWithRoles(document.getElementById('mod_rolePick'), _rolesCache);
      fillSelectWithChannels(document.getElementById('mod_channelPick'), _channelsCache, { onlySendable: false });

      fillSelectWithChannels(document.getElementById('raid_logChannelSel'), _channelsCache);
      fillSelectWithChannels(document.getElementById('logs_channelSel'), _channelsCache);
    }

    function selectedText(selectEl) {
      if (!selectEl) return '';
      const opt = selectEl.options?.[selectEl.selectedIndex];
      return opt ? String(opt.textContent || '') : '';
    }

    function applyTicketQuickConfig() {
      const categorySel = document.getElementById('ticket_categorySel');
      const staffSel = document.getElementById('ticket_staffRoleSel');
      const logSel = document.getElementById('ticket_logChannelSel');

      const ticketCategoryId = categorySel?.value || '';
      const ticketStaffRoleId = staffSel?.value || '';
      const logChannelId = logSel?.value || '';

      if (!ticketCategoryId || !ticketStaffRoleId) {
        toast('Selecciona categor√≠a y rol de staff', 'err');
        return;
      }

      const area = document.getElementById('settings_tickets');
      const current = safeJsonParse(area?.value, {}) || {};
      current.ticketCategoryId = ticketCategoryId;
      current.ticketStaffRoleId = ticketStaffRoleId;
      current.logChannelId = logChannelId || null;
      if (!current.channelNameTemplate) current.channelNameTemplate = 'ticket-{order}-{user}-{plan}';
      if (area) area.value = pretty(current);

      toast('Configuraci√≥n aplicada al JSON');
    }

    async function copyText(id) {
      const el = document.getElementById(id);
      const text = el ? String(el.value || el.textContent || '') : '';
      if (!text) return toast('Nada para copiar', 'err');
      await navigator.clipboard.writeText(text);
      toast('Copiado');
    }

    function makeUserMention() {
      const uid = document.getElementById('help_userId')?.value?.trim();
      if (!uid) return toast('Pega el userId', 'err');
      const out = `<@${uid}>`;
      const dst = document.getElementById('help_userMention');
      if (dst) dst.value = out;
      toast('Menci√≥n generada');
    }

    function bindHelpPickers() {
      const chSel = document.getElementById('help_channelSel');
      const roleSel = document.getElementById('help_roleSel');
      if (chSel) {
        chSel.addEventListener('change', () => {
          const v = chSel.value ? `<#${chSel.value}>` : '';
          const dst = document.getElementById('help_channelMention');
          if (dst) dst.value = v;
        });
      }
      if (roleSel) {
        roleSel.addEventListener('change', () => {
          const v = roleSel.value ? `<@&${roleSel.value}>` : '';
          const dst = document.getElementById('help_roleMention');
          if (dst) dst.value = v;
        });
      }
    }

    function fillHelpTemplates() {
      const txt = [
        '‚úÖ Bienvenido {mention} a **{guildName}**',
        'üë• Miembros: **{memberCount}**',
        '',
        'üìå Canales √∫tiles:',
        '- Reglas: <#CANAL_REGLAS_ID>',
        '- Tickets: <#CANAL_TICKETS_ID>',
        '',
        'üì© Soporte: abre un ticket y te responderemos pronto.',
        '',
        'Menciones:',
        '- Rol Staff: <@&ROL_STAFF_ID>',
        '- Usuario: <@USER_ID>',
      ].join('\n');
      const area = document.getElementById('help_templates');
      if (area && !String(area.value || '').trim()) area.value = txt;
    }

    async function copyTicketMentions() {
      const categorySel = document.getElementById('ticket_categorySel');
      const staffSel = document.getElementById('ticket_staffRoleSel');
      const logSel = document.getElementById('ticket_logChannelSel');
      const out = [
        `Categoria: ${categorySel?.value ? `<#${categorySel.value}>` : '(sin categor√≠a)'}`,
        `Staff: ${staffSel?.value ? `<@&${staffSel.value}>` : '(sin rol)'}`,
        `Logs: ${logSel?.value ? `<#${logSel.value}>` : '(sin logs)'}`,
        `Nombres: ticket-{order}-{user}-{plan}`,
      ].join('\n');
      await navigator.clipboard.writeText(out);
      toast('Menciones copiadas');
    }

    function renderPurchasePlans() {
      const host = document.getElementById('purchase_plansList');
      if (!host) return;
      host.innerHTML = '';

      if (!_purchasePlans.length) {
        const empty = document.createElement('div');
        empty.className = 'text-sm text-white/60';
        empty.textContent = 'Agrega al menos 1 producto.';
        host.appendChild(empty);
        return;
      }

      _purchasePlans.forEach((p, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'glass rounded-xl p-3 space-y-2';

        wrap.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-bold">${(p.label || 'Producto').replaceAll('<', '&lt;')}</div>
            <button class="btn btnD" type="button" data-i="${idx}">Quitar</button>
          </div>
          <div class="grid grid-cols-1 xl:grid-cols-4 gap-2">
            <input class="in" data-k="label" data-i="${idx}" placeholder="Nombre (ej: Mensual)" value="${(p.label || '').replaceAll('"', '&quot;')}" />
            <input class="in" data-k="value" data-i="${idx}" placeholder="C√≥digo (ej: mensual)" value="${(p.value || '').replaceAll('"', '&quot;')}" />
            <input class="in" data-k="description" data-i="${idx}" placeholder="Descripci√≥n (ej: $5 / 30 d√≠as)" value="${(p.description || '').replaceAll('"', '&quot;')}" />
            <input class="in" data-k="emoji" data-i="${idx}" placeholder="Emoji (ej: üíé)" value="${(p.emoji || '').replaceAll('"', '&quot;')}" />
          </div>
        `;

        wrap.querySelector('button.btnD')?.addEventListener('click', () => {
          _purchasePlans.splice(idx, 1);
          renderPurchasePlans();
        });

        wrap.querySelectorAll('input[data-k]')?.forEach((inp) => {
          inp.addEventListener('input', () => {
            const i = Number(inp.getAttribute('data-i'));
            const k = String(inp.getAttribute('data-k'));
            if (!_purchasePlans[i]) return;
            _purchasePlans[i][k] = inp.value;
          });
        });

        host.appendChild(wrap);
      });
    }

    function addPurchasePlan(seed = null) {
      const base = seed && typeof seed === 'object' ? seed : {};
      const next = {
        label: base.label || 'Producto',
        value: base.value || `prod_${Date.now()}`,
        description: base.description || 'Descripci√≥n',
        emoji: base.emoji || 'üü©',
      };
      _purchasePlans.push(next);
      renderPurchasePlans();
    }

    function channelNameById(id) {
      const c = (_channelsCache || []).find((x) => String(x.id) === String(id));
      return c ? buildChannelLabel(c) : String(id);
    }
    function roleNameById(id) {
      const r = (_rolesCache || []).find((x) => String(x.id) === String(id));
      return r ? String(r.name || r.id) : String(id);
    }

    function renderModExemptLists() {
      const rolesHost = document.getElementById('mod_rolesList');
      if (rolesHost) {
        rolesHost.innerHTML = '';
        (_modExemptRoleIds || []).forEach((rid) => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between glass rounded-xl px-3 py-2';
          row.innerHTML = `<div class="text-sm">${roleNameById(rid)}</div><button class="btn btnD" type="button">Quitar</button>`;
          row.querySelector('button')?.addEventListener('click', () => {
            _modExemptRoleIds = _modExemptRoleIds.filter((x) => String(x) !== String(rid));
            renderModExemptLists();
          });
          rolesHost.appendChild(row);
        });
      }

      const chansHost = document.getElementById('mod_channelsList');
      if (chansHost) {
        chansHost.innerHTML = '';
        (_modExemptChannelIds || []).forEach((cid) => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between glass rounded-xl px-3 py-2';
          row.innerHTML = `<div class="text-sm">${channelNameById(cid)}</div><button class="btn btnD" type="button">Quitar</button>`;
          row.querySelector('button')?.addEventListener('click', () => {
            _modExemptChannelIds = _modExemptChannelIds.filter((x) => String(x) !== String(cid));
            renderModExemptLists();
          });
          chansHost.appendChild(row);
        });
      }
    }

    function addModExemptRole() {
      const pick = document.getElementById('mod_rolePick');
      const rid = pick?.value || '';
      if (!rid) return toast('Selecciona un rol', 'err');
      if (_modExemptRoleIds.some((x) => String(x) === String(rid))) return toast('Ya est√° agregado');
      _modExemptRoleIds.push(rid);
      renderModExemptLists();
    }

    function addModExemptChannel() {
      const pick = document.getElementById('mod_channelPick');
      const cid = pick?.value || '';
      if (!cid) return toast('Selecciona un canal', 'err');
      if (_modExemptChannelIds.some((x) => String(x) === String(cid))) return toast('Ya est√° agregado');
      _modExemptChannelIds.push(cid);
      renderModExemptLists();
    }

    function ensureDefaults() {
      const defaults = {
        purchase_embed: {
          title: 'TCC',
          description: '‚úÖ Venta de los mejores productos\nüì© Contacta con un vendedor o staff\n‚ö†Ô∏è Para evitar estafas y problemas',
          color: '#ff2d2d',
          image: 'https://i.imgur.com/0Z8FQ2a.jpeg',
          footer: 'Powered by TCC',
        },
        purchase_plans: [
          { label: 'Panel B√°sico', value: 'panel_basico', description: 'Acceso 1 mes', emoji: 'üü©' },
          { label: 'Bypass', value: 'bypass', description: 'Acceso 1 mes', emoji: 'üõ°Ô∏è' },
          { label: 'Panel Extreme', value: 'panel_extreme', description: 'Acceso 1 mes', emoji: 'üî•' },
        ],
        purchase_placeholder: '¬°ADQUIERE EL PRODUCTO ‚ú®',
        support_title: 'TCC',
        support_description: 'Abre el ticket para poder realizar una compra o consulta del producto.\n\nDe esta manera un miembro de **TCC OFICIAL** te responder√° lo m√°s r√°pido posible para atenderte.\n\n- No abrir ticket sin raz√≥n alguna',
        support_buttonLabel: 'Abrir Ticket',
        welcome_easy: {
          enabled: true,
          pingUser: true,
          content: '‚úÖ Bienvenido {mention} a **{guildName}**\nüìå Lee las reglas y disfruta tu estancia',
          embed: {
            title: 'TCC',
            description: 'üë• Miembros: **{memberCount}**\n\nüì© Si necesitas ayuda, abre un ticket.',
            color: '#ff2d2d',
            image: 'https://i.imgur.com/0Z8FQ2a.jpeg',
            footer: 'Powered by TCC',
          },
          deleteAfterSeconds: 0,
        },
        verify_easy: {
          enabled: true,
          panelTitle: '‚úÖ Verificaci√≥n',
          panelDescription: 'Presiona el bot√≥n para verificarte.',
          panelColor: '#ff2d2d',
          buttonLabel: 'Verificarme',
        },
        settings_tickets: {
          ticketCategoryId: 'Pega aqu√≠ la categor√≠a de tickets (o usa Setup)',
          ticketStaffRoleId: 'Pega aqu√≠ el rol Staff/Soporte',
          logChannelId: 'Pega aqu√≠ el canal de logs (opcional)',
          channelNameTemplate: 'ticket-{order}-{user}-{plan}',
        },
        editMsgPayload: { content: 'Actualizaci√≥n:', embed: { title: 'Novedades', description: 'Texto...', color: '#22c55e' }, buttons: [] },
      };

      const pTitle = document.getElementById('purchase_title');
      if (pTitle && !String(pTitle.value || '').trim()) pTitle.value = defaults.purchase_embed.title;
      const pDesc = document.getElementById('purchase_description');
      if (pDesc && !String(pDesc.value || '').trim()) pDesc.value = defaults.purchase_embed.description;
      const pColor = document.getElementById('purchase_color');
      if (pColor && !String(pColor.value || '').trim()) pColor.value = defaults.purchase_embed.color;
      const pImg = document.getElementById('purchase_image');
      if (pImg && !String(pImg.value || '').trim()) pImg.value = defaults.purchase_embed.image;
      const pFoot = document.getElementById('purchase_footer');
      if (pFoot && !String(pFoot.value || '').trim()) pFoot.value = defaults.purchase_embed.footer;

      if (!_purchasePlans.length) {
        _purchasePlans = defaults.purchase_plans.map((x) => ({ ...x }));
        renderPurchasePlans();
      }
      const pph = document.getElementById('purchase_placeholder');
      if (pph && !String(pph.value || '').trim()) pph.value = defaults.purchase_placeholder;

      const st = document.getElementById('support_title');
      if (st && !String(st.value || '').trim()) st.value = defaults.support_title;
      const sd = document.getElementById('support_description');
      if (sd && !String(sd.value || '').trim()) sd.value = defaults.support_description;
      const sb = document.getElementById('support_buttonLabel');
      if (sb && !String(sb.value || '').trim()) sb.value = defaults.support_buttonLabel;

      const ts = document.getElementById('settings_tickets');
      if (ts && !String(ts.value || '').trim()) ts.value = pretty(defaults.settings_tickets);

      const we = defaults.welcome_easy;
      const wEnabled = document.getElementById('welcome_enabled');
      if (wEnabled && wEnabled.checked === false && !wEnabled.hasAttribute('data-touched')) wEnabled.checked = Boolean(we.enabled);
      const wPing = document.getElementById('welcome_ping');
      if (wPing && wPing.checked === false && !wPing.hasAttribute('data-touched')) wPing.checked = Boolean(we.pingUser);
      const wContent = document.getElementById('welcome_content');
      if (wContent && !String(wContent.value || '').trim()) wContent.value = we.content;
      const wET = document.getElementById('welcome_embedTitle');
      if (wET && !String(wET.value || '').trim()) wET.value = we.embed.title;
      const wED = document.getElementById('welcome_embedDesc');
      if (wED && !String(wED.value || '').trim()) wED.value = we.embed.description;
      const wEC = document.getElementById('welcome_embedColor');
      if (wEC && !String(wEC.value || '').trim()) wEC.value = we.embed.color;
      const wEI = document.getElementById('welcome_embedImage');
      if (wEI && !String(wEI.value || '').trim()) wEI.value = we.embed.image;
      const wEF = document.getElementById('welcome_embedFooter');
      if (wEF && !String(wEF.value || '').trim()) wEF.value = we.embed.footer;
      const wDel = document.getElementById('welcome_deleteAfter');
      if (wDel && !String(wDel.value || '').trim()) wDel.value = String(we.deleteAfterSeconds || 0);

      const ve = defaults.verify_easy;
      const vEnabled = document.getElementById('verify_enabled');
      if (vEnabled && vEnabled.checked === false && !vEnabled.hasAttribute('data-touched')) vEnabled.checked = Boolean(ve.enabled);
      const vPT = document.getElementById('verify_panelTitle');
      if (vPT && !String(vPT.value || '').trim()) vPT.value = ve.panelTitle;
      const vPD = document.getElementById('verify_panelDesc');
      if (vPD && !String(vPD.value || '').trim()) vPD.value = ve.panelDescription;
      const vPC = document.getElementById('verify_panelColor');
      if (vPC && !String(vPC.value || '').trim()) vPC.value = ve.panelColor;
      const vBL = document.getElementById('verify_buttonLabel');
      if (vBL && !String(vBL.value || '').trim()) vBL.value = ve.buttonLabel;

      const ep = document.getElementById('editMsgPayload');
      if (ep && !String(ep.value || '').trim()) ep.value = pretty(defaults.editMsgPayload);
    }

    function buildWelcomeSettingsFromEasy() {
      const channelId = document.getElementById('welcome_cfgChannelSel')?.value || null;
      const enabled = Boolean(document.getElementById('welcome_enabled')?.checked);
      const pingUser = Boolean(document.getElementById('welcome_ping')?.checked);
      const content = document.getElementById('welcome_content')?.value?.trim() || '';
      const deleteAfterSeconds = Number(document.getElementById('welcome_deleteAfter')?.value || 0) || 0;
      const embed = {
        title: document.getElementById('welcome_embedTitle')?.value?.trim() || null,
        description: document.getElementById('welcome_embedDesc')?.value?.trim() || null,
        color: document.getElementById('welcome_embedColor')?.value?.trim() || null,
        image: document.getElementById('welcome_embedImage')?.value?.trim() || null,
        footer: document.getElementById('welcome_embedFooter')?.value?.trim() || null,
      };
      const settings = {
        enabled,
        channelId,
        pingUser,
        content,
        embed,
        deleteAfterSeconds,
      };
      return settings;
    }

    function applyWelcomeEasyFromSettings(settings) {
      const s = settings && typeof settings === 'object' ? settings : {};
      const enabled = s.enabled !== false;
      const pingUser = Boolean(s.pingUser);
      const channelId = s.channelId || s.welcomeChannelId || '';
      const embed = (s.embed && typeof s.embed === 'object') ? s.embed : {};

      const elEnabled = document.getElementById('welcome_enabled');
      if (elEnabled) elEnabled.checked = enabled;
      const elPing = document.getElementById('welcome_ping');
      if (elPing) elPing.checked = pingUser;
      const selCh = document.getElementById('welcome_cfgChannelSel');
      if (selCh && channelId) selCh.value = String(channelId);
      const elContent = document.getElementById('welcome_content');
      if (elContent) elContent.value = String(s.content || '');
      const elET = document.getElementById('welcome_embedTitle');
      if (elET) elET.value = String(embed.title || '');
      const elED = document.getElementById('welcome_embedDesc');
      if (elED) elED.value = String(embed.description || '');
      const elEC = document.getElementById('welcome_embedColor');
      if (elEC) elEC.value = String(embed.color || '');
      const elEI = document.getElementById('welcome_embedImage');
      if (elEI) elEI.value = String(embed.image || '');
      const elEF = document.getElementById('welcome_embedFooter');
      if (elEF) elEF.value = String(embed.footer || '');
      const elDel = document.getElementById('welcome_deleteAfter');
      if (elDel) elDel.value = String(Number(s.deleteAfterSeconds || 0) || 0);
    }

    async function loadWelcomeEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const data = await api(`/api/settings/welcome?guildId=${encodeURIComponent(guildId)}`);
      const area = document.getElementById('settings_welcome');
      if (area) area.value = pretty(data || {});
      applyWelcomeEasyFromSettings(data || {});
      toast('Bienvenida cargada');
    }

    async function saveWelcomeEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const settings = buildWelcomeSettingsFromEasy();
      const area = document.getElementById('settings_welcome');
      if (area) area.value = pretty(settings);
      await api('/api/settings/welcome', { method: 'PUT', body: JSON.stringify({ guildId, settings }) });
      toast('Bienvenida guardada');
    }

    function buildVerifySettingsFromEasy() {
      const enabled = Boolean(document.getElementById('verify_enabled')?.checked);
      const roleId = document.getElementById('verify_roleSel')?.value || null;
      const autoRoleId = document.getElementById('verify_autoRoleSel')?.value || null;
      const panelTitle = document.getElementById('verify_panelTitle')?.value?.trim() || null;
      const panelDescription = document.getElementById('verify_panelDesc')?.value?.trim() || null;
      const panelColor = document.getElementById('verify_panelColor')?.value?.trim() || null;
      const buttonLabel = document.getElementById('verify_buttonLabel')?.value?.trim() || null;
      return { enabled, roleId, autoRoleId, panelTitle, panelDescription, panelColor, buttonLabel };
    }

    function buildModerationSettingsFromEasy() {
      const enabled = Boolean(document.getElementById('mod_enabled')?.checked);
      const blockLinks = Boolean(document.getElementById('mod_links')?.checked);
      const blockInvites = Boolean(document.getElementById('mod_invites')?.checked);
      const spamEnabled = Boolean(document.getElementById('mod_spam')?.checked);
      const spamWindowMs = Number(document.getElementById('mod_spamWindow')?.value || 7000) || 7000;
      const spamMaxMsgs = Number(document.getElementById('mod_spamMax')?.value || 6) || 6;
      const spamTimeoutMs = Number(document.getElementById('mod_spamTimeout')?.value || 60000) || 60000;
      const logChannelId = document.getElementById('mod_logChannelSel')?.value || null;
      const whitelistDomains = String(document.getElementById('mod_whitelist')?.value || '')
        .split(/\r?\n/)
        .map((s) => String(s).trim())
        .filter(Boolean);

      return {
        enabled,
        blockLinks,
        blockInvites,
        spamEnabled,
        spamWindowMs,
        spamMaxMsgs,
        spamTimeoutMs,
        whitelistDomains,
        exemptRoleIds: _modExemptRoleIds || [],
        exemptChannelIds: _modExemptChannelIds || [],
        logChannelId,
      };
    }

    function applyModerationEasyFromSettings(settings) {
      const s = settings && typeof settings === 'object' ? settings : {};
      document.getElementById('mod_enabled').checked = s.enabled !== false;
      document.getElementById('mod_links').checked = Boolean(s.blockLinks);
      document.getElementById('mod_invites').checked = Boolean(s.blockInvites);
      document.getElementById('mod_spam').checked = s.spamEnabled !== false;
      document.getElementById('mod_spamWindow').value = String(Number(s.spamWindowMs || 7000));
      document.getElementById('mod_spamMax').value = String(Number(s.spamMaxMsgs || 6));
      document.getElementById('mod_spamTimeout').value = String(Number(s.spamTimeoutMs || 60000));
      const logSel = document.getElementById('mod_logChannelSel');
      if (logSel && s.logChannelId) logSel.value = String(s.logChannelId);
      document.getElementById('mod_whitelist').value = (Array.isArray(s.whitelistDomains) ? s.whitelistDomains : []).join('\n');

      _modExemptRoleIds = Array.isArray(s.exemptRoleIds) ? s.exemptRoleIds.slice() : [];
      _modExemptChannelIds = Array.isArray(s.exemptChannelIds) ? s.exemptChannelIds.slice() : [];
      renderModExemptLists();
    }

    async function loadModerationEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const data = await api(`/api/settings/moderation?guildId=${encodeURIComponent(guildId)}`);
      const area = document.getElementById('settings_moderation');
      if (area) area.value = pretty(data || {});
      applyModerationEasyFromSettings(data || {});
      toast('Moderaci√≥n cargada');
    }

    async function saveModerationEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const settings = buildModerationSettingsFromEasy();
      const area = document.getElementById('settings_moderation');
      if (area) area.value = pretty(settings);
      await api('/api/settings/moderation', { method: 'PUT', body: JSON.stringify({ guildId, settings }) });
      toast('Moderaci√≥n guardada');
    }

    function buildRaidSettingsFromEasy() {
      const enabled = Boolean(document.getElementById('raid_enabled')?.checked);
      const joinWindowMs = Number(document.getElementById('raid_joinWindow')?.value || 15000) || 15000;
      const joinThreshold = Number(document.getElementById('raid_joinThreshold')?.value || 8) || 8;
      const defenseDurationMs = Number(document.getElementById('raid_duration')?.value || 300000) || 300000;
      const slowmodeSeconds = Number(document.getElementById('raid_slowmode')?.value || 10) || 10;
      const lockLinks = Boolean(document.getElementById('raid_lockLinks')?.checked);
      const logChannelId = document.getElementById('raid_logChannelSel')?.value || null;
      return { enabled, joinWindowMs, joinThreshold, defenseDurationMs, slowmodeSeconds, lockLinks, logChannelId };
    }

    function applyRaidEasyFromSettings(settings) {
      const s = settings && typeof settings === 'object' ? settings : {};
      document.getElementById('raid_enabled').checked = Boolean(s.enabled);
      document.getElementById('raid_joinWindow').value = String(Number(s.joinWindowMs || 15000));
      document.getElementById('raid_joinThreshold').value = String(Number(s.joinThreshold || 8));
      document.getElementById('raid_duration').value = String(Number(s.defenseDurationMs || 300000));
      document.getElementById('raid_slowmode').value = String(Number(s.slowmodeSeconds || 10));
      document.getElementById('raid_lockLinks').checked = s.lockLinks != null ? Boolean(s.lockLinks) : true;
      const sel = document.getElementById('raid_logChannelSel');
      if (sel && s.logChannelId) sel.value = String(s.logChannelId);
    }

    async function loadRaidEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const data = await api(`/api/settings/raid?guildId=${encodeURIComponent(guildId)}`);
      const area = document.getElementById('settings_raid');
      if (area) area.value = pretty(data || {});
      applyRaidEasyFromSettings(data || {});
      toast('Anti-raid cargado');
    }

    async function saveRaidEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const settings = buildRaidSettingsFromEasy();
      const area = document.getElementById('settings_raid');
      if (area) area.value = pretty(settings);
      await api('/api/settings/raid', { method: 'PUT', body: JSON.stringify({ guildId, settings }) });
      toast('Anti-raid guardado');
    }

    function buildLogsSettingsFromEasy() {
      const enabled = Boolean(document.getElementById('logs_enabled')?.checked);
      const channelId = document.getElementById('logs_channelSel')?.value || null;
      const logJoins = Boolean(document.getElementById('logs_joins')?.checked);
      const logLeaves = Boolean(document.getElementById('logs_leaves')?.checked);
      const logMessageDelete = Boolean(document.getElementById('logs_delete')?.checked);
      const logMessageEdit = Boolean(document.getElementById('logs_edit')?.checked);
      return { enabled, channelId, logJoins, logLeaves, logMessageDelete, logMessageEdit };
    }

    function applyLogsEasyFromSettings(settings) {
      const s = settings && typeof settings === 'object' ? settings : {};
      document.getElementById('logs_enabled').checked = s.enabled !== false;
      const sel = document.getElementById('logs_channelSel');
      if (sel && s.channelId) sel.value = String(s.channelId);
      document.getElementById('logs_joins').checked = Boolean(s.logJoins);
      document.getElementById('logs_leaves').checked = Boolean(s.logLeaves);
      document.getElementById('logs_delete').checked = Boolean(s.logMessageDelete);
      document.getElementById('logs_edit').checked = Boolean(s.logMessageEdit);
    }

    async function loadLogsEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const data = await api(`/api/settings/logs?guildId=${encodeURIComponent(guildId)}`);
      const area = document.getElementById('settings_logs');
      if (area) area.value = pretty(data || {});
      applyLogsEasyFromSettings(data || {});
      toast('Logs cargado');
    }

    async function saveLogsEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const settings = buildLogsSettingsFromEasy();
      if (!settings.channelId) throw new Error('Selecciona canal de logs');
      const area = document.getElementById('settings_logs');
      if (area) area.value = pretty(settings);
      await api('/api/settings/logs', { method: 'PUT', body: JSON.stringify({ guildId, settings }) });
      toast('Logs guardado');
    }

    function fillMessageEasyExamples() {
      const c = document.getElementById('msg_content');
      if (c && !String(c.value || '').trim()) {
        c.value = '‚úÖ **TCC**\n\nüì© Abre ticket para soporte o compra.\n‚ö†Ô∏è No abrir ticket sin raz√≥n.';
      }
      const et = document.getElementById('embed_title');
      if (et && !String(et.value || '').trim()) et.value = 'TCC';
      const ed = document.getElementById('embed_description');
      if (ed && !String(ed.value || '').trim()) ed.value = 'üìå Selecciona una opci√≥n en el men√∫ o abre un ticket.\n\nüë• Staff responder√° lo m√°s r√°pido posible.';
      const ec = document.getElementById('embed_color');
      if (ec && !String(ec.value || '').trim()) ec.value = '#ff2d2d';
      const ei = document.getElementById('embed_image');
      if (ei && !String(ei.value || '').trim()) ei.value = 'https://i.imgur.com/0Z8FQ2a.jpeg';
      const ef = document.getElementById('embed_footer');
      if (ef && !String(ef.value || '').trim()) ef.value = 'Powered by TCC';
      toast('Ejemplos cargados');
    }

    async function sendMessageEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const channelId = document.getElementById('msg_channelSel')?.value || '';
      const content = document.getElementById('msg_content')?.value?.trim() || '';
      if (!channelId) throw new Error('Selecciona un canal');
      if (!content) throw new Error('Escribe el texto');
      await api('/api/send-message', { method: 'POST', body: JSON.stringify({ guildId, channelId, content }) });
      toast('Mensaje enviado');
    }

    async function sendEmbedEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const channelId = document.getElementById('embed_channelSel')?.value || '';
      if (!channelId) throw new Error('Selecciona un canal');
      const embed = {
        title: document.getElementById('embed_title')?.value?.trim() || null,
        description: document.getElementById('embed_description')?.value?.trim() || null,
        color: document.getElementById('embed_color')?.value?.trim() || null,
        image: document.getElementById('embed_image')?.value?.trim() || null,
        footer: document.getElementById('embed_footer')?.value?.trim() || null,
      };
      await api('/api/send-embed', { method: 'POST', body: JSON.stringify({ guildId, channelId, embed, buttons: [] }) });
      toast('Embed enviado');
    }

    async function sendImageEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const channelId = document.getElementById('img_channelSel')?.value || '';
      const imageUrl = document.getElementById('img_url')?.value?.trim() || '';
      const caption = document.getElementById('img_caption')?.value?.trim() || null;
      if (!channelId) throw new Error('Selecciona un canal');
      if (!imageUrl) throw new Error('Pega la URL de la imagen');
      await api('/api/send-image', { method: 'POST', body: JSON.stringify({ guildId, channelId, imageUrl, caption }) });
      toast('Imagen enviada');
    }

    function applyVerifyEasyFromSettings(settings) {
      const s = settings && typeof settings === 'object' ? settings : {};
      const elEnabled = document.getElementById('verify_enabled');
      if (elEnabled) elEnabled.checked = s.enabled !== false;
      const rs = document.getElementById('verify_roleSel');
      if (rs && s.roleId) rs.value = String(s.roleId);
      const ars = document.getElementById('verify_autoRoleSel');
      if (ars && s.autoRoleId) ars.value = String(s.autoRoleId);
      const pt = document.getElementById('verify_panelTitle');
      if (pt) pt.value = String(s.panelTitle || '');
      const pd = document.getElementById('verify_panelDesc');
      if (pd) pd.value = String(s.panelDescription || '');
      const pc = document.getElementById('verify_panelColor');
      if (pc) pc.value = String(s.panelColor || '');
      const bl = document.getElementById('verify_buttonLabel');
      if (bl) bl.value = String(s.buttonLabel || '');
    }

    async function loadVerifyEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const data = await api(`/api/settings/verify?guildId=${encodeURIComponent(guildId)}`);
      const area = document.getElementById('settings_verify');
      if (area) area.value = pretty(data || {});
      applyVerifyEasyFromSettings(data || {});
      toast('Verificaci√≥n cargada');
    }

    async function saveVerifyEasy() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const settings = buildVerifySettingsFromEasy();
      if (!settings.roleId) throw new Error('Selecciona el rol de verificaci√≥n');
      const area = document.getElementById('settings_verify');
      if (area) area.value = pretty(settings);
      await api('/api/settings/verify', { method: 'PUT', body: JSON.stringify({ guildId, settings }) });
      toast('Verificaci√≥n guardada');
    }

    async function bootstrap() {
      if (!token) {
        setView(false);
        return;
      }
      try {
        await loadBotInfo();
        await loadGuilds();
        ensureDefaults();
        fillHelpTemplates();
        bindHelpPickers();
        bindSelectToInput('support_channelSel', 'support_channelId');
        bindSelectToInput('purchase_channelSel', 'purchase_channelId');
        bindSelectToInput('welcome_channelSel', 'welcome_channelId');
        bindSelectToInput('verify_channelSel', 'verify_channelId');
        bindSelectToInput('tplPublishChannelSel', 'tplPublishChannel');
        bindSelectToInput('editMsgChannelSel', 'editMsgChannel');
        await refreshPickers();
        setView(true);
      } catch (e) {
        token = null;
        localStorage.removeItem('dashboardToken');
        setView(false);
        toast(String(e.message || e), 'err');
      }
    }

    async function doLogin() {
      document.getElementById('err').classList.add('hidden');
      try {
        const out = await api('/api/login', { method: 'POST', body: JSON.stringify({ password: document.getElementById('pw').value }) });
        token = out?.token || document.getElementById('pw').value;
        localStorage.setItem('dashboardToken', token);
        document.getElementById('pw').value = '';
        await bootstrap();
        toast('‚úÖ Login correcto');
      } catch (e) {
        document.getElementById('err').classList.remove('hidden');
        toast(String(e.message || e), 'err');
      }
    }

    function doLogout() {
      token = null;
      localStorage.removeItem('dashboardToken');
      setView(false);
      showSection('overview');
    }

    document.getElementById('btnLogin').addEventListener('click', doLogin);
    document.getElementById('pw').addEventListener('keydown', (ev) => { if (ev.key === 'Enter') doLogin(); });

    document.getElementById('btnSetApi').addEventListener('click', () => {
      const v = normalizeApiBase(document.getElementById('apiInput')?.value);
      if (!v) {
        toast('Debes pegar una URL v√°lida de Railway', 'err');
        return;
      }
      API_BASE = v;
      localStorage.setItem('dashboardApiBase', API_BASE);
      document.getElementById('apiLbl').textContent = API_BASE;
      toast('API guardada');
    });

    document.getElementById('apiInput').addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') document.getElementById('btnSetApi').click();
    });

    document.getElementById('btnLogout').addEventListener('click', doLogout);
    document.getElementById('btnRefresh').addEventListener('click', bootstrap);

    document.getElementById('guild').addEventListener('change', () => {
      guildId = document.getElementById('guild').value;
      localStorage.setItem('dashboardGuildId', guildId);
      refreshPickers().catch(() => null);
    });

    document.querySelectorAll('.nav').forEach((el) => {
      el.addEventListener('click', () => showSection(el.getAttribute('data-s')));
    });
    document.querySelectorAll('[data-go]').forEach((el) => {
      el.addEventListener('click', () => showSection(el.getAttribute('data-go')));
    });

    function safeJsonParse(text, fallback = null) {
      try {
        const trimmed = String(text || '').trim();
        if (!trimmed) return fallback;
        return JSON.parse(trimmed);
      } catch (_) {
        return fallback;
      }
    }

    function safeErrDetails(e) {
      try {
        if (!e) return null;
        if (typeof e === 'string') return e;
        const stack = e && e.stack ? String(e.stack) : null;
        const msg = e && e.message ? String(e.message) : null;
        return stack || msg || String(e);
      } catch (_) {
        return null;
      }
    }

    window.addEventListener('error', (ev) => {
      try {
        const err = ev?.error;
        const msg = String(err?.message || ev?.message || 'Error');
        const details = safeErrDetails(err) || `${ev?.filename || ''}:${ev?.lineno || ''}:${ev?.colno || ''}`;
        console.error('Dashboard error:', err || ev);
        toast(msg, 'err', details);
      } catch (_) {
      }
    });

    window.addEventListener('unhandledrejection', (ev) => {
      try {
        const reason = ev?.reason;
        const msg = String(reason?.message || 'Unhandled Promise Rejection');
        const details = safeErrDetails(reason);
        console.error('Unhandled rejection:', reason);
        toast(msg, 'err', details);
      } catch (_) {
      }
    });

    function safeStringify(obj, space = 2, { maxDepth = 8 } = {}) {
      const seen = new WeakSet();
      function helper(value, depth) {
        if (value == null) return value;
        const t = typeof value;
        if (t === 'string' || t === 'number' || t === 'boolean') return value;
        if (t === 'bigint') return String(value);
        if (t === 'function') return '[Function]';
        if (t !== 'object') return String(value);
        if (seen.has(value)) return '[Circular]';
        if (depth >= maxDepth) return '[MaxDepth]';
        seen.add(value);

        if (Array.isArray(value)) {
          return value.map((v) => helper(v, depth + 1));
        }

        const out = {};
        for (const k of Object.keys(value)) {
          out[k] = helper(value[k], depth + 1);
        }
        return out;
      }

      return JSON.stringify(helper(obj, 0), null, space);
    }

    function pretty(obj) {
      try { return safeStringify(obj ?? {}, 2, { maxDepth: 10 }); } catch { return String(obj ?? ''); }
    }

    async function loadSettingsTickets() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const data = await api(`/api/settings/tickets?guildId=${encodeURIComponent(guildId)}`);
      const area = document.getElementById('settings_tickets');
      if (area) area.value = pretty(data || {});
      toast('Tickets: settings cargado');
    }

    async function saveSettingsTickets() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const area = document.getElementById('settings_tickets');
      const settings = safeJsonParse(area?.value, null);
      if (!settings || typeof settings !== 'object') throw new Error('JSON inv√°lido en settings');
      await api('/api/settings/tickets', { method: 'PUT', body: JSON.stringify({ guildId, settings }) });
      toast('Tickets: settings guardado');
    }

    async function publishSupportPanel() {
      const channelId = document.getElementById('support_channelId')?.value?.trim();
      if (!channelId) throw new Error('channelId requerido');
      const title = document.getElementById('support_title')?.value?.trim() || null;
      const description = document.getElementById('support_description')?.value?.trim() || null;
      const buttonLabel = document.getElementById('support_buttonLabel')?.value?.trim() || null;
      await api('/api/tickets/support-panel', { method: 'POST', body: JSON.stringify({ channelId, title, description, buttonLabel }) });
      toast('Panel de soporte publicado');
    }

    async function publishPurchasePanel() {
      const channelId = document.getElementById('purchase_channelId')?.value?.trim();
      if (!channelId) throw new Error('channelId requerido');
      const placeholder = document.getElementById('purchase_placeholder')?.value?.trim() || null;
      const embed = {
        title: document.getElementById('purchase_title')?.value?.trim() || null,
        description: document.getElementById('purchase_description')?.value?.trim() || null,
        color: document.getElementById('purchase_color')?.value?.trim() || null,
        image: document.getElementById('purchase_image')?.value?.trim() || null,
        footer: document.getElementById('purchase_footer')?.value?.trim() || null,
      };

      const plans = (_purchasePlans || [])
        .map((p) => ({
          label: String(p.label || '').trim(),
          value: String(p.value || '').trim(),
          description: String(p.description || '').trim(),
          emoji: String(p.emoji || '').trim() || undefined,
        }))
        .filter((p) => p.label && p.value);

      if (!plans.length) throw new Error('Agrega al menos 1 producto');
      await api('/api/tickets/purchase-shop-panel', { method: 'POST', body: JSON.stringify({ channelId, embed, plans, placeholder }) });
      toast('Panel de compras publicado');
    }

    async function loadSettingsWelcome() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const data = await api(`/api/settings/welcome?guildId=${encodeURIComponent(guildId)}`);
      const area = document.getElementById('settings_welcome');
      if (area) area.value = pretty(data || {});
      toast('Bienvenida: settings cargado');
    }

    async function saveSettingsWelcome() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const area = document.getElementById('settings_welcome');
      const settings = safeJsonParse(area?.value, null);
      if (!settings || typeof settings !== 'object') throw new Error('JSON inv√°lido en settings');
      await api('/api/settings/welcome', { method: 'PUT', body: JSON.stringify({ guildId, settings }) });
      toast('Bienvenida: settings guardado');
    }

    async function publishWelcomePreview() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const channelId = document.getElementById('welcome_channelId')?.value?.trim();
      if (!channelId) throw new Error('channelId requerido');
      await api('/api/welcome/publish', { method: 'POST', body: JSON.stringify({ guildId, channelId }) });
      toast('Preview de bienvenida publicado');
    }

    async function loadSettingsVerify() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const data = await api(`/api/settings/verify?guildId=${encodeURIComponent(guildId)}`);
      const area = document.getElementById('settings_verify');
      if (area) area.value = pretty(data || {});
      toast('Verificaci√≥n: settings cargado');
    }

    async function saveSettingsVerify() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const area = document.getElementById('settings_verify');
      const settings = safeJsonParse(area?.value, null);
      if (!settings || typeof settings !== 'object') throw new Error('JSON inv√°lido en settings');
      await api('/api/settings/verify', { method: 'PUT', body: JSON.stringify({ guildId, settings }) });
      toast('Verificaci√≥n: settings guardado');
    }

    async function publishVerifyPanel() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const channelId = document.getElementById('verify_channelId')?.value?.trim();
      if (!channelId) throw new Error('channelId requerido');
      await api('/api/verify/panel', { method: 'POST', body: JSON.stringify({ guildId, channelId }) });
      toast('Panel de verificaci√≥n publicado');
    }

    function fillTemplateExample(type) {
      const examples = {
        simple: { content: 'Hola! Este es un mensaje simple.' },
        embed: {
          embed: { title: 'T√≠tulo', description: 'Descripci√≥n del embed', color: '#ff2d2d', footer: 'DRIF CHEATS' },
          buttons: [{ label: 'Abrir Ticket', style: 'Primary', customId: 'noop_ticket' }],
        },
        image: { imageUrl: 'https://i.imgur.com/0Z8FQ2a.jpeg', caption: 'Imagen + texto' },
        product: {
          embed: { title: 'Producto', description: 'Descripci√≥n del producto', color: '#22c55e' },
          buttons: [{ label: 'Comprar', style: 'Success', customId: 'noop_buy' }],
        },
      };
      const t = String(type || 'simple');
      const sel = document.getElementById('tplType');
      if (sel) sel.value = t;
      const area = document.getElementById('tplData');
      if (area) area.value = pretty(examples[t] || examples.simple);
    }

    async function loadTemplates() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const list = document.getElementById('tplList');
      if (list) list.innerHTML = '<div class="text-sm text-white/60">Cargando‚Ä¶</div>';
      const items = await api(`/api/templates?guildId=${encodeURIComponent(guildId)}`);
      if (!list) return;
      list.innerHTML = '';
      if (!Array.isArray(items) || items.length === 0) {
        list.innerHTML = '<div class="text-sm text-white/60">Sin plantillas a√∫n.</div>';
        return;
      }

      for (const t of items) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'glass rounded-xl px-4 py-3 text-left w-full';
        const name = String(t.name || '(sin nombre)');
        const type = String(t.type || 'simple');
        const updatedAt = t.updatedAt ? String(t.updatedAt) : '';
        btn.innerHTML = `<div class="flex items-center justify-between"><div class="font-bold">${escapeHtml(name)}</div><div class="text-xs text-white/60">${escapeHtml(type)}</div></div>` +
          `<div class="text-xs text-white/60 mt-1">${escapeHtml(updatedAt)}</div>`;
        btn.addEventListener('click', () => fillTemplateForm(t));
        list.appendChild(btn);
      }
      toast('Plantillas cargadas');
    }

    function fillTemplateForm(t) {
      document.getElementById('tplId').value = t?.id || '';
      document.getElementById('tplName').value = t?.name || '';
      document.getElementById('tplType').value = t?.type || 'simple';
      document.getElementById('tplData').value = pretty(t?.data || {});
    }

    function clearTemplateForm() {
      document.getElementById('tplId').value = '';
      document.getElementById('tplName').value = '';
      document.getElementById('tplType').value = 'simple';
      document.getElementById('tplData').value = '';
    }

    async function saveTemplate() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const id = document.getElementById('tplId')?.value?.trim();
      const name = document.getElementById('tplName')?.value?.trim();
      const type = document.getElementById('tplType')?.value;
      if (!name) throw new Error('Nombre requerido');
      if (!type) throw new Error('Tipo requerido');
      const data = safeJsonParse(document.getElementById('tplData')?.value, null);
      if (data == null || typeof data !== 'object') throw new Error('data JSON inv√°lido');

      if (id) {
        await api(`/api/templates/${encodeURIComponent(id)}`, { method: 'PUT', body: JSON.stringify({ guildId, name, type, data }) });
        toast('Plantilla actualizada');
      } else {
        const out = await api('/api/templates', { method: 'POST', body: JSON.stringify({ guildId, name, type, data }) });
        if (out?.id) document.getElementById('tplId').value = out.id;
        toast('Plantilla creada');
      }
      await loadTemplates();
    }

    async function deleteTemplate() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const id = document.getElementById('tplId')?.value?.trim();
      if (!id) throw new Error('templateId requerido');
      await api(`/api/templates/${encodeURIComponent(id)}?guildId=${encodeURIComponent(guildId)}`, { method: 'DELETE' });
      toast('Plantilla eliminada');
      clearTemplateForm();
      await loadTemplates();
    }

    async function publishTemplate() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const templateId = document.getElementById('tplId')?.value?.trim();
      const channelId = document.getElementById('tplPublishChannel')?.value?.trim();
      if (!templateId) throw new Error('templateId requerido');
      if (!channelId) throw new Error('channelId requerido');
      const out = await api('/api/publish-template', { method: 'POST', body: JSON.stringify({ guildId, templateId, channelId }) });
      toast('Publicado. messageId: ' + (out?.messageId || '-'));
    }

    async function editMessage() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const channelId = document.getElementById('editMsgChannel')?.value?.trim();
      const messageId = document.getElementById('editMsgId')?.value?.trim();
      if (!channelId || !messageId) throw new Error('channelId y messageId requeridos');
      const payload = safeJsonParse(document.getElementById('editMsgPayload')?.value, null);
      if (!payload || typeof payload !== 'object') throw new Error('JSON inv√°lido');
      const body = {
        guildId,
        channelId,
        messageId,
        content: payload.content ?? undefined,
        embed: payload.embed ?? undefined,
        buttons: payload.buttons ?? undefined,
      };
      const out = await api('/api/edit-message', { method: 'POST', body: JSON.stringify(body) });
      toast('Mensaje editado. messageId: ' + (out?.messageId || messageId));
    }

    async function loadSettingsModeration() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const data = await api(`/api/settings/moderation?guildId=${encodeURIComponent(guildId)}`);
      const area = document.getElementById('settings_moderation');
      if (area) area.value = pretty(data || {});
      toast('Moderaci√≥n: settings cargado');
    }

    async function saveSettingsModeration() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const area = document.getElementById('settings_moderation');
      const settings = safeJsonParse(area?.value, null);
      if (!settings || typeof settings !== 'object') throw new Error('JSON inv√°lido en settings');
      await api('/api/settings/moderation', { method: 'PUT', body: JSON.stringify({ guildId, settings }) });
      toast('Moderaci√≥n: settings guardado');
    }

    async function loadSettingsRaid() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const data = await api(`/api/settings/raid?guildId=${encodeURIComponent(guildId)}`);
      const area = document.getElementById('settings_raid');
      if (area) area.value = pretty(data || {});
      toast('Anti-Raid: settings cargado');
    }

    async function saveSettingsRaid() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const area = document.getElementById('settings_raid');
      const settings = safeJsonParse(area?.value, null);
      if (!settings || typeof settings !== 'object') throw new Error('JSON inv√°lido en settings');
      await api('/api/settings/raid', { method: 'PUT', body: JSON.stringify({ guildId, settings }) });
      toast('Anti-Raid: settings guardado');
    }

    async function loadSettingsLogs() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const data = await api(`/api/settings/logs?guildId=${encodeURIComponent(guildId)}`);
      const area = document.getElementById('settings_logs');
      if (area) area.value = pretty(data || {});
      toast('Logs: settings cargado');
    }

    async function saveSettingsLogs() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const area = document.getElementById('settings_logs');
      const settings = safeJsonParse(area?.value, null);
      if (!settings || typeof settings !== 'object') throw new Error('JSON inv√°lido en settings');
      await api('/api/settings/logs', { method: 'PUT', body: JSON.stringify({ guildId, settings }) });
      toast('Logs: settings guardado');
    }

    async function setupPlan() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const out = await api('/api/setup/plan', { method: 'POST', body: JSON.stringify({ guildId }) });
      const area = document.getElementById('setup_plan_out');
      if (area) area.value = pretty(out?.plan || out);
      toast('Setup plan generado');
    }

    async function setupApply() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const out = await api('/api/setup/apply', { method: 'POST', body: JSON.stringify({ guildId }) });
      toast('Setup aplicado');
      const area = document.getElementById('setup_plan_out');
      if (area) area.value = pretty(out?.created || out);
    }

    async function setupConfigureAll() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const publishChannelId = document.getElementById('setup_publish_channel')?.value?.trim() || null;
      const out = await api('/api/setup/configure-all', { method: 'POST', body: JSON.stringify({ guildId, publishChannelId }) });
      toast('Configure-all ejecutado');
      const area = document.getElementById('setup_plan_out');
      if (area) area.value = pretty(out);
    }

    async function loadHealth() {
      const health = await api('/api/health', { headers: {} });
      let hc = null;
      if (guildId) {
        hc = await api(`/api/healthcheck/guild?guildId=${encodeURIComponent(guildId)}`);
      }
      const area = document.getElementById('health_out');
      if (area) area.value = pretty({ health, guild: hc });
      toast('Salud actualizada');
    }

    async function loadHistory() {
      if (!guildId) throw new Error('Selecciona un servidor');
      const items = await api(`/api/history?guildId=${encodeURIComponent(guildId)}`);
      const area = document.getElementById('history_out');
      if (area) area.value = pretty(items || []);
      toast('Historial cargado');
    }

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"]/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]));
    }

    // API p√∫blica para botones onclick
    window.loadSettings = async (key) => {
      try {
        if (key === 'tickets') return await loadSettingsTickets();
        if (key === 'welcome') return await loadSettingsWelcome();
        if (key === 'verify') return await loadSettingsVerify();
        if (key === 'moderation') return await loadSettingsModeration();
        if (key === 'raid') return await loadSettingsRaid();
        if (key === 'logs') return await loadSettingsLogs();
        throw new Error('Secci√≥n no implementada a√∫n: ' + key);
      } catch (e) {
        toast(String(e.message || e), 'err');
      }
    };

    window.saveSettings = async (key) => {
      try {
        if (key === 'tickets') return await saveSettingsTickets();
        if (key === 'welcome') return await saveSettingsWelcome();
        if (key === 'verify') return await saveSettingsVerify();
        if (key === 'moderation') return await saveSettingsModeration();
        if (key === 'raid') return await saveSettingsRaid();
        if (key === 'logs') return await saveSettingsLogs();
        throw new Error('Secci√≥n no implementada a√∫n: ' + key);
      } catch (e) {
        toast(String(e.message || e), 'err');
      }
    };

    window.publishSupportPanel = async () => {
      try { await publishSupportPanel(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.publishPurchasePanel = async () => {
      try { await publishPurchasePanel(); } catch (e) { toast(String(e.message || e), 'err'); }
    };

    window.addPurchasePlan = () => {
      try { addPurchasePlan(); } catch (e) { toast(String(e.message || e), 'err'); }
    };

    window.applyTicketQuickConfig = () => {
      try { applyTicketQuickConfig(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.copyTicketMentions = async () => {
      try { await copyTicketMentions(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.copyText = async (id) => {
      try { await copyText(id); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.makeUserMention = () => {
      try { makeUserMention(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.fillHelpTemplates = () => {
      try { fillHelpTemplates(); toast('Ejemplos cargados'); } catch (e) { toast(String(e.message || e), 'err'); }
    };

    window.publishWelcomePreview = async () => {
      try { await publishWelcomePreview(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.publishVerifyPanel = async () => {
      try { await publishVerifyPanel(); } catch (e) { toast(String(e.message || e), 'err'); }
    };

    window.loadWelcomeEasy = async () => {
      try { await loadWelcomeEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.saveWelcomeEasy = async () => {
      try { await saveWelcomeEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.loadVerifyEasy = async () => {
      try { await loadVerifyEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.saveVerifyEasy = async () => {
      try { await saveVerifyEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };

    window.loadModerationEasy = async () => {
      try { await loadModerationEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.saveModerationEasy = async () => {
      try { await saveModerationEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.addModExemptRole = () => {
      try { addModExemptRole(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.addModExemptChannel = () => {
      try { addModExemptChannel(); } catch (e) { toast(String(e.message || e), 'err'); }
    };

    window.loadRaidEasy = async () => {
      try { await loadRaidEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.saveRaidEasy = async () => {
      try { await saveRaidEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };

    window.loadLogsEasy = async () => {
      try { await loadLogsEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.saveLogsEasy = async () => {
      try { await saveLogsEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };

    window.fillMessageEasyExamples = () => {
      try { fillMessageEasyExamples(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.sendMessageEasy = async () => {
      try { await sendMessageEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.sendEmbedEasy = async () => {
      try { await sendEmbedEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.sendImageEasy = async () => {
      try { await sendImageEasy(); } catch (e) { toast(String(e.message || e), 'err'); }
    };

    window.loadTemplates = async () => {
      try { await loadTemplates(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.saveTemplate = async () => {
      try { await saveTemplate(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.deleteTemplate = async () => {
      try { await deleteTemplate(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.publishTemplate = async () => {
      try { await publishTemplate(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.editMessage = async () => {
      try { await editMessage(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.clearTemplateForm = clearTemplateForm;
    window.fillTemplateExample = fillTemplateExample;

    window.setupPlan = async () => {
      try { await setupPlan(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.setupApply = async () => {
      try { await setupApply(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.setupConfigureAll = async () => {
      try { await setupConfigureAll(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.loadHealth = async () => {
      try { await loadHealth(); } catch (e) { toast(String(e.message || e), 'err'); }
    };
    window.loadHistory = async () => {
      try { await loadHistory(); } catch (e) { toast(String(e.message || e), 'err'); }
    };

    bootstrap();
  </script>
</body>
</html>
